<script>
  // çµµæ–‡å­—ã®æº–å‚™ â†©ï¸ ğŸ—‘ ğŸ’¾ ğŸ” âœ…
  //--------------------------------------------------------------------------------
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã®å®šç¾©
  //--------------------------------------------------------------------------------

  // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š (Configuration)
  const arrDef = {
    STUDENT_DATA: {},
    EXAM_DATA: {},
  }

  const config = {
    myMailAddress: '',
    userRole: '',
    inputEnable: false,
    studentMailAddress: '',
    examMaxInputCount: 0,
    examTypeOptions: [],
    resultOptions: [],
    teacherData: [],
    allStudentsData: [],
    currentStudentData: [],
    examDataList: [],
    universityCodeList: [],
    universityCodeSerial: "0"
  };

  // DOMè¦ç´ ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  const dom = {};

  // å…¥åŠ›ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«é–¢é€£
  //--------------------------------------------------------------------------------
  let selectedProceedRadioId = ""; // é¸æŠã•ã‚Œã¦ã„ã‚‹é€²å­¦å…ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ID

  // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ (Status)
  const status = {
    isItemChanged: false,
    isDeleted: false,
    isUniversityCodeLoading: false
  };

  //================================================================================
  // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
  //================================================================================
  // ãƒ€ã‚¤ã‚¢ãƒ­ã‚° (ãƒ–ãƒ©ã‚¦ã‚¶ä¾å­˜ã‚ã‚Š)
  const confirmAsync = async (title, message) => {
    if (dom.confirmDialogTitle) dom.confirmDialogTitle.textContent = title;
    if (dom.confirmDialogMessage) dom.confirmDialogMessage.innerHTML = message; // HTMLã§è¨˜è¿°å¯
    dom.confirmDialog?.showModal();
    return new Promise(resolve => {
      const eventBase = flag => () => {
        dom.confirmDialog.close();
        dom.confirmDialogButtonYes.removeEventListener("click", okEvent);
        dom.confirmDialogButtonNo.removeEventListener("click", cancelEvent);
        resolve(flag);
      };
      const okEvent = eventBase(true);
      const cancelEvent = eventBase(false);
      dom.confirmDialogButtonYes.addEventListener("click", okEvent);
      dom.confirmDialogButtonNo.addEventListener("click", cancelEvent);
    });
  }

  // æ–‡å­—åˆ—ã‚’ãƒ–ãƒ¼ãƒ«å€¤ã«å¤‰æ›ã™ã‚‹(Sheet APIã§booleanã®æˆ»ã‚Šå€¤ã¯æ–‡å­—åˆ—)
  const isTrue = (val) => {
    return String(val).toUpperCase() === 'TRUE';
  }

  const UNIVERSITY_DATA_CACHE = {
    dataKey: 'universityDataCache',
    timestampKey: 'universityDataTimestamp',
    serialKey: 'universityCodeSerial',
    duration: 24 * 60 * 60 * 1000 // 24æ™‚é–“
  };

  //================================================================================
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥é–¢é€£(æ‰‹å‹•ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢)
  //================================================================================
  function clearUniversityDataCache() {
    return clearCache(UNIVERSITY_DATA_CACHE);
  }

  //================================================================================
  // UI STATE CONTROL
  //================================================================================
  function setElementHidden(element, flag) {
    element.classList.toggle('is-hidden', flag);
  }

  function setPdfButtonDisabled(flag) {
    document.querySelectorAll('.button-pdf').forEach(btn => btn.disabled = flag);
  }

  function setSendButtonDisabled(flag) {
    document.querySelectorAll('.button-send').forEach(btn => btn.disabled = flag);
  }

  function setExitButtonHidden(flag) {
    document.querySelectorAll('.button-exit').forEach(btn => btn.classList.toggle('is-hidden', flag));
  }

  function setSendMessage(text) {
    document.querySelectorAll('.button-alert-message').forEach(item => item.textContent = text);
  }

  function setDialogBackdrop(element, flag) {
    element.classList.toggle('back-drop', flag);
  }

  function cacheDomElements() {
    const ids = [
      "confirmDialogTitle", "confirmDialogMessage", "confirmDialog",
      "confirmDialogButtonYes", "confirmDialogButtonNo", "headerTitle",
      "currentUserName", "classSelection", "studentNumberSelection",
      "progressDialogMessageContainer", "inputTableContainer", "progressDialog", "statusMessage",
      "sendFormButton1", "sendFormButton2", "issueReportButton1", "issueReportButton2",
      "searchMessage", "searchTableContainer", "searchButton", "keywordInput", "moveLeftButton",
      "moveRightButton", "cancelButton", "searchBackground", "searchBody",
      "examRowTemplate", "sendFormButton1Message", "sendFormButton2Message",
      "displayCountTotal", "displayCountRange", "inputBackground",
      "selectorSection", "inputSection", "classSelectionContainer", "targetStudentName"
    ];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el) dom[id] = el;
    });
  }

  //--------------------------------------------------------------------------------
  // ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
  //--------------------------------------------------------------------------------
  function pageLoaded() {
    cacheDomElements();
    window.onbeforeunload = null;
    setDialogSpinner(" åˆæœŸãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­ãƒ»ãƒ»ãƒ»");
    setElementHidden(dom.selectorSection, true)
    setElementHidden(dom.inputSection, true)
    showProgressDialog(true);
    google.script.run
      .withSuccessHandler(onInitialDataReceived)
      .withFailureHandler(error => {
        console.error(error);
        showProgressDialog(false); // ãã‚‹ãã‚‹ã‚’æ¶ˆã™
        confirmAsync("ã‚¨ãƒ©ãƒ¼", "å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>æ™‚é–“ã‚’ãŠã„ã¦å†åº¦è©¦ã™ã‹ã€å…ˆç”Ÿã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚<br>è©³ç´°: " + error.message);
      })
      .getInitialData();
  }

  function onInitialDataReceived(strJSON) {
    const allData = JSON.parse(strJSON) || {};
    config.myMailAddress = allData.myMailAddress || "";
    arrDef.STUDENT_DATA = allData.studentStructure || {};
    arrDef.EXAM_DATA = allData.examStructure || {};
    config.userRole = allData.userRole || "";
    config.examMaxInputCount = allData.examMaxCount || 0;
    config.examTypeOptions = allData.examTypeOptions || [];
    config.resultOptions = allData.resultOptions || [];
    config.teacherData = allData.teacherData || [];
    config.currentStudentData = allData.studentData || [];
    config.examDataList = allData.examData || [];
    config.universityCodeSerial = allData.universityCodeSerial || "0";
    getUniversityDataList();
    setEventListeners();
    disableSendButton(true);
    if (dom.headerTitle) dom.headerTitle.textContent = allData.headerTitle;
    if (config.userRole === 'teacher') {
      if (dom.currentUserName) dom.currentUserName.textContent = "ã€æ•™å“¡ãƒ¢ãƒ¼ãƒ‰ã€‘" + config.teacherData[1];
      disableReportButton(true);
      setElementHidden(dom.selectorSection, true);
      setElementHidden(dom.inputSection, true);
      setDialogSpinner("ã€æ•™å“¡ãƒ¢ãƒ¼ãƒ‰ã€‘ç”Ÿå¾’ä¸€è¦§å–å¾—ä¸­ãƒ»ãƒ»ãƒ»");
      setDialogBackdrop(dom.progressDialog, false);
      google.script.run // ç”Ÿå¾’ä¸€è¦§ã‚’éåŒæœŸã§å–å¾—
        .withSuccessHandler(studentsJSON => {
          showProgressDialog(false);
          setDialogBackdrop(dom.progressDialog, true);
          config.allStudentsData = JSON.parse(studentsJSON) || [];
          showSelector();
        })
        .withFailureHandler(error => {
          showProgressDialog(false);
          setDialogBackdrop(dom.progressDialog, true);
          console.error(error);
          confirmAsync("ã‚¨ãƒ©ãƒ¼", "ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>è©³ç´°: " + error.message);
        })
        .getStudentsList();
    } else if (allData.userRole === 'student') {
      setDialogBackdrop(dom.progressDialog, false);
      setDialogSpinner("å—é¨“æ ¡ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...");
      config.inputEnable = allData.inputEnable;
      if (config.inputEnable === false) { // APIã§å€¤å–å¾—å¾Œã€ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ã§æ–‡å­—åˆ—ã‚’ãƒ–ãƒ¼ãƒ«ã«å¤‰æ›
        showProgressDialog(false);
        confirmAsync("æƒ…å ±", "ç¾åœ¨ã€ç®¡ç†è€…ã«ã‚ˆã‚Šå…¥åŠ›ãŒç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™ã€‚");
        return;
      }
      config.studentMailAddress = config.currentStudentData[arrDef.STUDENT_DATA.MAIL_ADDR];
      setStudentName("targetStudentName");
      setElementHidden(dom.selectorSection, true);
      setElementHidden(dom.inputSection, false);
      setInputTable(); // ç©ºã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å…ˆã«è¡¨ç¤º
      google.script.run // å—é¨“ãƒ‡ãƒ¼ã‚¿ã‚’éåŒæœŸã§å–å¾—
        .withSuccessHandler(examJSON => {
          showProgressDialog(false);
          setDialogBackdrop(dom.progressDialog, true);
          config.examDataList = JSON.parse(examJSON) || [];
          setInputTable(); // ãƒ‡ãƒ¼ã‚¿ã‚’åæ˜ 
        })
        .withFailureHandler(error => {
          showProgressDialog(false);
          setDialogBackdrop(dom.progressDialog, true);
          console.error(error);
          confirmAsync("ã‚¨ãƒ©ãƒ¼", "å—é¨“ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>è©³ç´°: " + error.message);
        })
        .getExamDataList();
    } else {
      showProgressDialog(false);
      confirmAsync("è­¦å‘Š", "å…¥åŠ›ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>ç®¡ç†è€…ã«å•ã„åˆã‚ã›ã¦ãã ã•ã„ã€‚");
      return;
    }
  }

  //--------------------------------------------------------------------------------
  // æ•™å“¡ãƒšãƒ¼ã‚¸ç”Ÿå¾’é¸æŠ
  //--------------------------------------------------------------------------------
  function showSelector() {
    setElementHidden(dom.selectorSection, false);
    setElementHidden(dom.studentNumberSelection, true);
    const classes = Array.from(new Set(config.allStudentsData.map(arr => arr[arrDef.STUDENT_DATA.CLASS])));
    classes.sort(); // ã‚¯ãƒ©ã‚¹åã§ã‚½ãƒ¼ãƒˆ
    createClassSelector(classes);
  }

  function createClassSelector(arr) { // ã‚¯ãƒ©ã‚¹ä¸€è¦§ãƒªã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹
    const selectEl = dom.classSelection;
    selectEl.replaceChildren();
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'é¸æŠ';
    defaultOption.selected = true;
    defaultOption.disabled = false;
    selectEl.appendChild(defaultOption);
    arr.forEach(className => { // ã‚¯ãƒ©ã‚¹ã®ãƒªã‚¹ãƒˆã‹ã‚‰ <option> è¦ç´ ã‚’ç”Ÿæˆã—ã¦è¿½åŠ 
      const option = document.createElement('option');
      option.value = className;
      option.textContent = className + 'çµ„';
      selectEl.appendChild(option);
    });
  }

  function createStudentList() { // é¸æŠã•ã‚ŒãŸã‚¯ãƒ©ã‚¹ã®ç”Ÿå¾’ä¸€è¦§ç”Ÿæˆ
    setElementHidden(dom.inputSection, true);
    const selClassId = dom.classSelection;
    const selClass = selClassId.value;
    const students = config.allStudentsData.filter(row => String(row[arrDef.STUDENT_DATA.CLASS]) === String(selClass));
    if (students.length === 0) {
      setElementHidden(dom.studentNumberSelection, true);
      return;
    }
    setElementHidden(dom.studentNumberSelection, false);
    const selNumDiv = dom.studentNumberSelection;
    selNumDiv.replaceChildren();
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'é¸æŠ';
    defaultOption.selected = true;
    defaultOption.disabled = false;
    selNumDiv.appendChild(defaultOption);
    students.forEach(student => {
      const option = document.createElement('option');
      option.value = student[arrDef.STUDENT_DATA.MAIL_ADDR];
      let strNum = ('0' + student[arrDef.STUDENT_DATA.NUMBER] + 'ï¼š').slice(-3);
      option.textContent = strNum + student[arrDef.STUDENT_DATA.NAME];
      const regCount = parseInt(student[arrDef.STUDENT_DATA.REG_COUNT], 10) || 0;
      if (regCount === 0) {
        option.classList.add('is-empty');
      }
      selNumDiv.appendChild(option);
    });
  }

  async function handleStudentSelect() {
    try {
      if (status.isItemChanged && !await confirmAsync("ç¢ºèª", "å¤‰æ›´ã‚’ä¿å­˜ã›ãšã«ç§»å‹•ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹")) {
        return;
      }
      const selectEl = dom.studentNumberSelection;
      const mailAddr = selectEl.value;
      if (mailAddr.length === 0) {
        return;
      }
      config.currentStudentData = config.allStudentsData.find(row => row[0] === mailAddr)
      config.studentMailAddress = mailAddr;
      setStudentName("targetStudentName");
      getExamDataList()
    } catch (e) {
      console.error("error in handleStudentSelect", e);
    }
  }

  //--------------------------------------------------------------------------------
  // ãã®ä»–
  //--------------------------------------------------------------------------------
  function setDialogSpinner(text) {
    const idStatusMsg = dom.progressDialogMessageContainer;
    idStatusMsg.replaceChildren();
    if (text.length) {
      const divSpinner = document.createElement("div");
      divSpinner.className = "span-spinner-big"
      idStatusMsg.append(divSpinner)
      const divMessage = document.createElement("div");
      divMessage.textContent = text
      idStatusMsg.append(divMessage)
    }
  }

  // æœªä½¿ç”¨
  function disableScroll(event) {
    event.preventDefault();
  }

  function setInputVisibility(vis) {
    dom.inputTableContainer.style.visibility = vis;
  }

  function showProgressDialog(vis) {
    if (vis) {
      if (!dom.progressDialog.open) dom.progressDialog.showModal();
    } else {
      dom.progressDialog.close(); // å‰Šé™¤ã®ç¢ºèª
    }
  }

  //--------------------------------------------------------------------------------
  // å¤§å­¦ã‚³ãƒ¼ãƒ‰å–å¾—
  //--------------------------------------------------------------------------------
  const universityMap = new Map;

  async function getUniversityDataList() {
    const cacheConfig = UNIVERSITY_DATA_CACHE;
    if (await tryLoadFromCache(cacheConfig)) return; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’è©¦è¡Œ
    else await loadFromServer(cacheConfig); // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
  }

  async function tryLoadFromCache(conf) {
    try {
      const cachedData = localStorage.getItem(conf.dataKey);
      const cachedTimestamp = localStorage.getItem(conf.timestampKey);
      const cachedSerial = localStorage.getItem(conf.serialKey);
      if (!isValidCache(cachedData, cachedTimestamp, cachedSerial, conf)) {
        return false;
      }
      const decompressed = await decompressCachedData(cachedData);
      updateLoadingState('å¤§å­¦ãƒ‡ãƒ¼ã‚¿èª­è¾¼ä¸­ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰');
      onUniversityDataReceived(decompressed);
      return true;
    } catch (e) {
      console.warn('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—:', e);
      return false;
    }
  }

  function isValidCache(data, timestamp, serial, conf) {
    if (!data || !timestamp || !serial) return false;
    const isCurrentSerial = String(serial) === String(config.universityCodeSerial);
    const age = Date.now() - parseInt(timestamp);
    const isFresh = age < conf.duration;
    return isCurrentSerial && isFresh;
  }

  async function decompressCachedData(cachedData) {
    const compressedData = await base64ToUint8ArrayAsync(cachedData);
    return await decompressGzipAsync(compressedData);
  }

  async function loadFromServer(config) {
    updateLoadingState('å¤§å­¦ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...');
    try {
      const response = await fetchUniversityDataFromServer(); // ã‚µãƒ¼ãƒã‹ã‚‰å–å¾—ã—ãŸbase64
      await saveToCache(response, config);
      const decompressed = await decompressCachedData(response);
      onUniversityDataReceived(decompressed);
    } catch (e) {
      handleServerError(e, config);
    }
  }

  async function fetchUniversityDataFromServer() {
    return await new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .getUniversityDataList();
    });
  }

  async function saveToCache(response, conf) {
    try {
      localStorage.setItem(conf.dataKey, response);
      localStorage.setItem(conf.timestampKey, Date.now().toString());
      localStorage.setItem(conf.serialKey, config.universityCodeSerial);
    } catch (e) {
      console.warn('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜ã«å¤±æ•—:', e);
    }
  }

  function updateLoadingState(message) {
    status.isUniversityCodeLoading = true;
    disableSearchButton(true);
    setStatusMessage(message);
  }

  function handleServerError(error, conf) {
    console.error('ã‚µãƒ¼ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—:', error);
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
    clearCache(conf);
    showProgressDialog(false);
    confirmAsync("ã‚¨ãƒ©ãƒ¼", "å¤§å­¦ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚<br>è©³ç´°: " + error.message);
  }

  function clearCache(config) {
    try {
      localStorage.removeItem(config.dataKey);
      localStorage.removeItem(config.timestampKey);
      localStorage.removeItem(config.serialKey);
      return true;
    } catch (e) {
      console.warn('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ã«å¤±æ•—:', e);
      return false;
    }
  }
  /*
  // Base64ã‚’Uint8Arrayã«å¤‰æ› fetch APIã®Data URIã‚¹ã‚­ãƒ¼ãƒ ã‚’åˆ©ç”¨
  async function base64ToUint8ArrayAsync(base64) {
    // dataã‚¹ã‚­ãƒ¼ãƒ ã‚’ä½¿ã£ã¦Base64ã‚’Blobã¨ã—ã¦èª­ã¿è¾¼ã‚€
    const res = await fetch("data:application/octet-stream;base64," + base64);
    const buffer = await res.arrayBuffer();
    return new Uint8Array(buffer);
  }
  */
  async function base64ToUint8ArrayAsync(base64) {
    try {
      // atobã§Base64ã‚’ãƒã‚¤ãƒŠãƒªæ–‡å­—åˆ—ã«ãƒ‡ã‚³ãƒ¼ãƒ‰
      const binaryString = atob(base64);
      const len = binaryString.length;

      // ãƒã‚¤ãƒŠãƒªæ–‡å­—åˆ—ã‚’Uint8Arrayã«è»¢è¨˜
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }

      return bytes;
    } catch (e) {
      throw new Error('Base64ã®ãƒ‡ã‚³ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
    }
  }

  // gzipè§£å‡ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–APIä½¿ç”¨ï¼‰
  async function decompressGzipAsync(compressedData) {
    if (!window.DecompressionStream) {
      throw new Error('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯DecompressionStreamã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚Chrome 80+ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚');
    }
    const blob = new Blob([compressedData]);
    const decompressedStream = blob.stream().pipeThrough(
      new DecompressionStream('gzip')
    );
    const response = new Response(decompressedStream);
    const decompressedText = await response.text();
    return decompressedText;
  }

  function onUniversityDataReceived(str) {
    config.universityCodeList = JSON.parse(str) || [];
    config.universityCodeList.forEach(drow => universityMap.set(String(drow[0]), drow[1]));
    status.isUniversityCodeLoading = false;
    disableSearchButton(false);
    setStatusMessage('');
  }

  function setStatusMessage(text) {
    const idStatusMsg = dom.statusMessage;
    idStatusMsg.innerHTML = '';
    if (text.length) {
      const spanSpinner = document.createElement("span");
      spanSpinner.className = "span-spinner"
      idStatusMsg.append(spanSpinner)
      idStatusMsg.append(text)
    }
  }

  function disableSearchButton(flag) {
    const buttons = document.querySelectorAll('.search-button');
    buttons.forEach(button => {
      button.disabled = flag;
    });
    const texts = document.querySelectorAll('.university-code');
    texts.forEach(text => {
      text.disabled = flag;
    });
  }

  function setEventListeners() {
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼:classSelect
    dom.classSelection.addEventListener('change', createStudentList);
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼:studentSelectorInput
    dom.studentNumberSelection.addEventListener('change', handleStudentSelect);
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼:jukentableå…¨ä½“ã«ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    const inputTableContainer = dom.inputTableContainer;
    inputTableContainer.addEventListener('click', (event) => {
      const target = event.target;
      if (target.classList.contains('search-button')) {
        const row = target.closest('tr'); // ãƒœã‚¿ãƒ³ãŒæ‰€å±ã™ã‚‹è¡Œã‚’å–å¾—
        const rank = row.querySelector('.rank-cell').textContent;
        searchUniversityCode(rank);
      }
      if (target.classList.contains('clear-button')) {
        const row = target.closest('tr');
        const rank = row.querySelector('.rank-cell').textContent;
        clearRow(rank);
      }
      if (target.classList.contains('proceed-radio')) {
        onProceedRadioClicked(target);
      }
    });
    inputTableContainer.addEventListener('change', (event) => {
      const target = event.target;
      setItemChanged();
      if (target.classList.contains('university-code')) { // å¤§å­¦ã‚³ãƒ¼ãƒ‰ãŒå¤‰æ›´ã•ã‚ŒãŸ
        const row = target.closest('tr');
        const rank = row.querySelector('.rank-cell').textContent;
        setUniversityName('universityCode' + rank);
      }
    });
    // å—é¨“æ ¡ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒœã‚¿ãƒ³
    dom.sendFormButton1.addEventListener("click", sendExamDataWithRetry);
    dom.sendFormButton2.addEventListener("click", sendExamDataWithRetry);
    dom.issueReportButton1.addEventListener("click", requestReport);
    dom.issueReportButton2.addEventListener("click", requestReport);
    // searchtableå…¨ä½“ã«ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    const searchTableDiv = dom.searchTableContainer;

    searchTableDiv.addEventListener('click', (event) => {
      const target = event.target;
      if (target.classList.contains('select-button')) {
        const row = target.closest('tr');
        const dcode = row.dataset.dcode
        setUniversityCode(dcode);
      }
    });
    // æ¤œç´¢ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒœã‚¿ãƒ³
    dom.searchButton.addEventListener("click", () => { displayStart = 0; searchKeyword(); }); // å…ˆé ­ã‹ã‚‰è¡¨ç¤º
    dom.keywordInput.addEventListener("input", () => { displayStart = 0; searchKeyword(); }); // å…ˆé ­ã‹ã‚‰è¡¨ç¤º
    dom.moveLeftButton.addEventListener('click', () => { displayStart -= displayStep; searchKeyword(); }) // å‰ã®ãƒšãƒ¼ã‚¸ã¸
    dom.moveRightButton.addEventListener('click', () => { displayStart += displayStep; searchKeyword(); }); // æ¬¡ã®ãƒšãƒ¼ã‚¸ã¸
    dom.cancelButton.addEventListener("click", cancelSearch);
    dom.searchBackground.addEventListener("click", cancelSearch);
    dom.searchBody.addEventListener("click", (event) => { event.stopPropagation(); });

    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã®å–å¾—
    window.addEventListener('scroll', () => { currentY = window.scrollY; currentX = window.scrollX; });
  }

  //--------------------------------------------------------------------------------
  // å…¥åŠ›ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«é–¢é€£
  //--------------------------------------------------------------------------------

  function setStudentName(id) {
    let str = '';
    str += (config.currentStudentData?.[arrDef.STUDENT_DATA.GRADE] || "") + 'å¹´ ';
    str += (config.currentStudentData?.[arrDef.STUDENT_DATA.CLASS] || "") + 'çµ„ ';
    str += (config.currentStudentData?.[arrDef.STUDENT_DATA.NUMBER] || "") + 'ç•ª æ°å ';
    str += (config.currentStudentData?.[arrDef.STUDENT_DATA.NAME] || "");
    if (dom[id]) dom[id].textContent = str;
  }


  function disableReportButton(flag) {
    dom.issueReportButton1.disabled = flag;
    dom.issueReportButton2.disabled = flag;

  }
  function disableSendButton(flag) {
    dom.sendFormButton1.disabled = flag;
    dom.sendFormButton2.disabled = flag;
  }

  function setSendMessage(text) {
    dom.sendFormButton1Message.textContent = text;
    dom.sendFormButton2Message.textContent = text;
  }

  // å…¥åŠ›ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ
  function setInputTable() {
    // ãƒ†ãƒ¼ãƒ–ãƒ«æœ¬ä½“
    const template = dom.examRowTemplate;

    const tableBody = document.createElement('tbody');

    for (let i = 0; i < config.examMaxInputCount; i++) {
      const rowClone = template.content.cloneNode(true);
      const hasData = i < config.examDataList.length;
      const jukenItem = hasData ? config.examDataList[i] : null; // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°å–å¾—ã€ãªã‘ã‚Œã°null
      const dcode = rowClone.querySelector('.university-code');
      const dname = rowClone.querySelector('.university-name');
      const keitaiCell = rowClone.querySelector('.exam-type-select-cell');
      const gouhiCell = rowClone.querySelector('.result-select-cell');
      const shingakuRadio = rowClone.querySelector('.proceed-radio');
      const searchBtn = rowClone.querySelector('.search-button');
      const clearBtn = rowClone.querySelector('.clear-button');
      rowClone.querySelector('.rank-cell').textContent = i + 1;
      dcode.id = 'universityCode' + (i + 1);
      dname.id = 'universityName' + (i + 1);
      shingakuRadio.id = 'proceed' + (i + 1);
      searchBtn.id = 'searchButton' + (i + 1);
      clearBtn.id = 'deleteButton' + (i + 1);

      dom['universityCode' + (i + 1)] = dcode;
      dom['universityName' + (i + 1)] = dname;
      dom['proceed' + (i + 1)] = shingakuRadio;
      dom['searchButton' + (i + 1)] = searchBtn;
      dom['deleteButton' + (i + 1)] = clearBtn;

      if (hasData) {
        dcode.value = jukenItem[arrDef.EXAM_DATA.DAIGAKU_CODE] || '';
        dname.textContent = jukenItem[arrDef.EXAM_DATA.DAIGAKU_NAME] || '';
        keitaiCell.appendChild(createExamTypeSelect(i, jukenItem[arrDef.EXAM_DATA.KEITAI] || ''));
        gouhiCell.appendChild(createResultSelect(i, jukenItem[arrDef.EXAM_DATA.GOUHI] || ''));
        // ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ã‹ã‚‰æ¸¡ã•ã‚ŒãŸboolå€¤ã¯æ–‡å­—åˆ—
        if (isTrue(jukenItem[arrDef.EXAM_DATA.SHINGAKU]) === true) {
          shingakuRadio.checked = true;
          selectedProceedRadioId = shingakuRadio.id;
        }
      } else {
        keitaiCell.appendChild(createExamTypeSelect(i, ""));
        gouhiCell.appendChild(createResultSelect(i, ""));
      }
      tableBody.appendChild(rowClone);
    }
    const tr = document.createElement("tr");
    tr.classList.add("thead-row");
    tr.classList.add("table-header-row");
    // ãƒ˜ãƒƒãƒ€ãƒ¼ã®é…åˆ—
    const headers = [
      "No",
      "å¤§å­¦ã‚³ãƒ¼ãƒ‰",
      "å­¦æ ¡åãƒ»å­¦éƒ¨ãƒ»å­¦ç§‘ãƒ»æ–¹å¼ãƒ»æ—¥ç¨‹",
      "è©¦é¨“å½¢æ…‹",
      "åˆå¦",
      "é€²å­¦",
      "å‰Šé™¤"
    ];
    headers.forEach((text, i) => {
      const th = document.createElement("th");
      th.textContent = text;
      tr.appendChild(th);
    });
    const tHead = document.createElement('thead');
    tHead.appendChild(tr);
    const table = document.createElement('table');
    table.classList.add('input-table');
    table.appendChild(tHead);
    table.appendChild(tableBody);
    const inputTableContainer = dom.inputTableContainer;
    inputTableContainer.replaceChildren();
    inputTableContainer.appendChild(table);
    // å¤§å­¦ãƒ‡ãƒ¼ã‚¿ãŒæ—¢ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹
    if (status.isUniversityCodeLoading === false && config.universityCodeList.length > 0) {
      disableSearchButton(false);
    }
  }

  function checkDuplicate(inputId) {
    const input = dom[inputId];
    for (let i = 0; i < config.examMaxInputCount; i++) {
      let id = 'universityCode' + (i + 1);
      const ddata = dom[id];

      if (ddata !== input) {
        if (input.value.trim() === ddata.value.trim()) {
          return i + 1;
        }
      }
    }
    return 0;
  }

  function setUniversityName(dn) {
    const dcodeSpan = dom[dn];
    const dcode = dcodeSpan.value.trim();
    const dnameSpan = dom[dn.replace('universityCode', 'universityName')];

    if (dcode.length === 0) {
      dnameSpan.innerHTML = '';
      return;
    }
    const row = checkDuplicate(dn);
    if (row > 0) {
      dnameSpan.innerHTML = `<span style="color:red;">${dcode}ã¯å¿—æœ›æ ¡${row}ã¨é‡è¤‡ã—ã¦ã„ã¾ã™</span>`;
      dcodeSpan.value = ''; // ä¸æ­£ãªã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªã‚¢              
      return;
    }
    const dname = universityMap.get(dcode);
    if (dname) {
      dnameSpan.textContent = dname;
    } else {
      dnameSpan.innerHTML = `<span style="color:red;">ã‚³ãƒ¼ãƒ‰ã«èª¤ã‚ŠãŒã‚ã‚Šã¾ã™</span>`;
      dcodeSpan.value = ''; // ä¸æ­£ãªã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªã‚¢
    }
  }

  function createExamTypeSelect(i, selectedValue) {
    const select = document.createElement('select');
    select.name = 'examType' + (i + 1);
    select.id = 'examType' + (i + 1);
    dom['examType' + (i + 1)] = select;

    config.examTypeOptions.forEach(optionValue => {
      const option = document.createElement('option');
      option.value = optionValue;
      option.textContent = optionValue;
      if (optionValue === selectedValue) {
        option.selected = true;
      }
      select.appendChild(option);
    });
    return select;
  }

  function createResultSelect(i, selectedValue) {
    const select = document.createElement('select');
    select.name = 'result' + (i + 1);
    select.id = 'result' + (i + 1);
    dom['result' + (i + 1)] = select;
    config.resultOptions.forEach(optionValue => {
      const option = document.createElement('option');
      option.value = optionValue;
      option.textContent = optionValue;
      if (optionValue === selectedValue) {
        option.selected = true;
      }
      select.appendChild(option);
    });
    return select;
  }

  async function clearRow(i) {
    let result = await confirmAsync("å‰Šé™¤/å¾©å…ƒ", "å¿—æœ›æ ¡ " + i + " ã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ");
    if (result) {
      const idc = dom["universityCode" + i];
      const idb = dom["searchButton" + i];
      const idn = dom["universityName" + i];
      const idk = dom["examType" + i];
      const idr = dom["result" + i];
      const ids = dom["proceed" + i];
      const arrid = [idc, idb, idn, idk, idr, ids];
      const idd = dom["deleteButton" + i];
      if (idk.disabled === false) { // idc, idnã¯å¤§å­¦ã‚³ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿å‰ã¯ disable
        arrid.forEach(id => {
          id.disabled = true;
          id.style.textDecoration = "line-through";
          id.style.opacity = 0.6;
        });
        idd.textContent = "æˆ»ã™";
      } else {
        arrid.forEach(id => {
          id.disabled = false;
          id.style.textDecoration = "none";
          id.style.opacity = 1;
        });
        idd.textContent = "å‰Šé™¤";
      }
      setItemChanged();
    }
  }

  function onProceedRadioClicked(radioItem) {
    if (radioItem.id === selectedProceedRadioId) {
      radioItem.checked = false; // é¸æŠã‚’è§£é™¤
      selectedProceedRadioId = ""; // é¸æŠçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
      setItemChanged();
    } else {
      selectedProceedRadioId = radioItem.id;
    }
  }

  function setItemChanged() {
    if (!status.isItemChanged) {
      status.isItemChanged = true;
      disableSendButton(false);
      disableReportButton(true);
      setSendMessage('å¤‰æ›´æœ‰â†’')
      window.onbeforeunload = function (e) {
        e.returnValue = "å¤‰æ›´ã‚’ä¿å­˜ã›ãšã«ç§»å‹•ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ";
      }
    }
  }
  //--------------------------------------------------------------------------------
  // å¤§å­¦ã‚³ãƒ¼ãƒ‰ãƒ†ãƒ¼ãƒ–ãƒ«é–¢é€£
  //--------------------------------------------------------------------------------
  let currentRow = 0; // å¤§å­¦æ¤œç´¢ã‚’å‘¼ã³å‡ºã—ãŸè¡Œ
  let currentY = 0; //ç¾åœ¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®
  let currentX = 0;
  let inputPosY = 0; // inputãƒ†ãƒ¼ãƒ–ãƒ«ç¾åœ¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®
  let inputPosX = 0;
  let searchPosY = 0; // inputãƒ†ãƒ¼ãƒ–ãƒ«ç¾åœ¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®
  let searchPosX = 0;

  function toggleSearchDisplay(flag) {
    if (flag) {
      inputPosY = currentY;
      inputPosX = currentX;
      window.scrollTo(searchPosX, searchPosY);
      setElementHidden(dom.searchBackground, false);
      setElementHidden(dom.inputBackground, true);
    } else {
      searchPosY = currentY;
      searchPosX = currentX;
      window.scrollTo(inputPosX, inputPosY);
      setElementHidden(dom.searchBackground, true);
      setElementHidden(dom.inputBackground, false);
    }
  }

  function searchUniversityCode(row) {
    currentRow = row;
    toggleSearchDisplay(true);
    displayStart = 0;
    searchKeyword();
  }

  // æœ€å¾Œã®å…¥åŠ›ã‹ã‚‰æŒ‡å®šæ™‚é–“å¾Œã«å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã€Œãƒ‡ãƒã‚¦ãƒ³ã‚¹ã€é–¢æ•°
  let debounceTimer;

  function debounce(func, delay) {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(func, delay);
  }

  function setSearchMessage(text) {
    const idStatusMsg = dom.searchMessage;
    idStatusMsg.innerHTML = '';
    if (text.length) {
      const spanSpinner = document.createElement("span");
      spanSpinner.className = "span-spinner"
      idStatusMsg.append(spanSpinner)
      idStatusMsg.append(text)
    }
  }

  let displayStart = 0;
  const displayStep = 50;

  /*
  // ãƒ•ã‚£ãƒ«ã‚¿ã‚’ã‹ã‘ãŸãƒ‡ãƒ¼ã‚¿ã‚’éƒ½åº¦ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã™ã‚‹
  function getFilteredUniversity(searchWord) {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(str => resolve(JSON.parse(str)))
        .withFailureHandler(reject)
        .getFilteredUniversityDataList(searchWord, displayStart, displayStep);
    });
  }
  */

  function searchKeyword() {
    // ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ã‚’æŒŸã‚€
    debounce(async () => {
      const keywordInput = dom.keywordInput.value;
      const dcTotal = dom.displayCountTotal;
      const dcRange = dom.displayCountRange;
      const resultsContainer = dom.searchTableContainer;
      resultsContainer.replaceChildren(); // å‰å›ã®æ¤œç´¢çµæœã‚’ã‚¯ãƒª
      // ----- å¤§å­¦ãƒ‡ãƒ¼ã‚¿å…¨ä»¶äº‹å‰ãƒ­ãƒ¼ãƒ‰
      const keywords = keywordInput.replace(/ã€€/g, ' ').split(' ').filter(kw => kw); // ç©ºã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’é™¤å¤–
      const filteredData = config.universityCodeList.filter(row =>
        keywords.every(kw => (row[1] || "").includes(kw) || String(row[0] || "").includes(kw))
      );
      const limitedData = filteredData.slice(displayStart, displayStart + displayStep);
      const total = filteredData.length;
      // ----- å¤§å­¦ãƒ‡ãƒ¼ã‚¿éƒ½åº¦ã‚²ãƒƒãƒˆ
      /*
      setSearchMessage('ã€€æ¤œç´¢ä¸­ï¼ï¼ï¼');
      const objResult = await getFilteredUniversity(keywordInput);
      setSearchMessage('');
      const limitedData = objResult.data;
      const total = objResult.total;
      */
      // -----
      const moveLeft = dom.moveLeftButton;
      const moveRight = dom.moveRightButton;

      moveLeft.disabled = (displayStart <= 0);
      moveRight.disabled = (displayStart + displayStep >= total);
      const dend = total > displayStart + displayStep ? displayStart + displayStep : total
      dcRange.textContent = ` ${displayStart + 1} ï½ ${dend} `;
      dcTotal.textContent = ` ï¼ ${total} ä»¶`;
      // 2. æ¤œç´¢çµæœãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
      const table = document.createElement('table');
      table.classList.add('search-table');
      // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä½œæˆ
      const tableHead = table.createTHead();
      const headerRow = tableHead.insertRow();
      headerRow.classList.add('table-header-row');
      const headers = ['å­¦æ ¡åãƒ»å­¦éƒ¨ãƒ»å­¦ç§‘ãƒ»å…¥è©¦æ–¹å¼ãƒ»æ—¥ç¨‹', 'å¤§å­¦ã‚³ãƒ¼ãƒ‰', 'é¸æŠ'];
      headers.forEach(text => {
        const th = document.createElement('th');
        th.textContent = text;
        headerRow.appendChild(th);
      });
      const tableBody = table.createTBody();
      tableBody.id = "searchTable";
      limitedData.forEach(dataRow => {
        const code = dataRow[0];
        const name = dataRow[1];
        const tr = tableBody.insertRow();
        tr.classList.add("result-row");
        tr.dataset.dcode = dataRow[0];
        tr.dataset.dname = dataRow[1];
        // å­¦æ ¡åã‚»ãƒ«
        const nameCell = tr.insertCell();
        nameCell.textContent = name;
        nameCell.dataset.label = "å­¦æ ¡åç­‰ï¼š"; // ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œã®ãƒ©ãƒ™ãƒ«
        // å¤§å­¦ã‚³ãƒ¼ãƒ‰ã‚»ãƒ«
        const codeCell = tr.insertCell();
        codeCell.dataset.label = "ã‚³ãƒ¼ãƒ‰ï¼š";
        codeCell.classList.add("text-center");
        const codeInput = document.createElement('input');
        codeInput.type = 'text';
        codeInput.value = code;
        codeInput.readOnly = true;
        codeInput.size = 10;
        codeCell.appendChild(codeInput);
        // é¸æŠãƒœã‚¿ãƒ³ã‚»ãƒ«
        const buttonCell = tr.insertCell();
        buttonCell.classList.add("text-center");
        const selectButton = document.createElement('button');
        selectButton.textContent = 'é¸æŠ';
        selectButton.classList.add("select-button");
        buttonCell.appendChild(selectButton);
      });
      resultsContainer.appendChild(table);
    }, 800);
  }

  function setUniversityCode(dcode) {
    const dcodeSpan = dom['universityCode' + currentRow];

    dcodeSpan.value = String(dcode);
    setUniversityName('universityCode' + currentRow);
    setItemChanged();
    cancelSearch(); // æ¤œç´¢ç”»é¢ã‚’é–‰ã˜ã‚‹
  }

  function cancelSearch() {
    toggleSearchDisplay(false);
  }

  //--------------------------------------------------------------------------------
  // ãƒ‡ãƒ¼ã‚¿é€ä¿¡
  //--------------------------------------------------------------------------------
  //================================================================================
  // é€šä¿¡ãƒªãƒˆãƒ©ã‚¤åˆ¶å¾¡ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼ (Exponential Backoff)
  //================================================================================
  /**
   * google.script.run ã‚’ PromiseåŒ–ã—ã€è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ã‚’è¿½åŠ ã—ãŸãƒ©ãƒƒãƒ‘ãƒ¼é–¢æ•°
   * @param {string} funcName - å‘¼ã³å‡ºã™ã‚µãƒ¼ãƒãƒ¼å´é–¢æ•°å (ä¾‹: 'saveExamDataList')
   * @param {Array} args - é–¢æ•°ã«æ¸¡ã™å¼•æ•°ã®é…åˆ— (ä¾‹: [jsonString, mail])
   * @param {Object} options - ãƒªãƒˆãƒ©ã‚¤è¨­å®š (ä»»æ„)
   * @returns {Promise<any>} æˆåŠŸæ™‚ã®æˆ»ã‚Šå€¤
   */
  async function runGoogleScriptWithRetry(funcName, args = [], options = {}) {
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
    const {
      maxRetries = 3,       // æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°
      initialDelay = 2000,  // åˆå›å¾…æ©Ÿæ™‚é–“ (ms)
      factor = 2,           // å¾…æ©Ÿæ™‚é–“ã®å¢—åŠ ä¿‚æ•° (2ç§’ -> 4ç§’ -> 8ç§’...)
      showToast = true      // ãƒªãƒˆãƒ©ã‚¤æ™‚ã«ç”»é¢ã«é€šçŸ¥ã‚’å‡ºã™ã‹
    } = options;
    let attempt = 0;
    while (true) {
      try {
        // google.script.run ã‚’ Promise ã§ãƒ©ãƒƒãƒ—ã—ã¦å®Ÿè¡Œ
        return await new Promise((resolve, reject) => {
          const runner = google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject);
          // é–¢æ•°åã§å‹•çš„ã«å‘¼ã³å‡ºã—ã€å¼•æ•°ã‚’å±•é–‹ã—ã¦æ¸¡ã™
          if (typeof runner[funcName] !== 'function') {
            reject(new Error(`Function '${funcName}' not found in google.script.run`));
            return;
          }
          runner[funcName](...args);
        });
      } catch (error) {
        attempt++;
        // ãƒªãƒˆãƒ©ã‚¤ä¸Šé™ã«é”ã—ãŸã‚‰ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã¦çµ‚äº†
        if (attempt > maxRetries) {
          console.error(`[Retry Failed] ${funcName}: Max retries reached.`, error);
          throw error;
        }
        // å¾…æ©Ÿæ™‚é–“ã‚’è¨ˆç®— (Exponential Backoff)
        // delay = initialDelay * (factor ^ (attempt - 1))
        let delay = initialDelay * Math.pow(factor, attempt - 1);
        // ã‚¸ãƒƒã‚¿ãƒ¼ (Jitter) ã‚’è¿½åŠ : å¾…æ©Ÿæ™‚é–“ã‚’ Â±20% ãƒ©ãƒ³ãƒ€ãƒ ã«ãšã‚‰ã™
        // ã“ã‚Œã«ã‚ˆã‚Šã€å…¨å“¡ãŒä¸€æ–‰ã«ãƒªãƒˆãƒ©ã‚¤ã—ã¦å†åº¦è¡çªã™ã‚‹ã®ã‚’é˜²ã
        const jitter = delay * 0.2 * (Math.random() - 0.5) * 2;
        const finalDelay = Math.round(delay + jitter);
        console.warn(`[Retry ${attempt}/${maxRetries}] ${funcName} failed. Retrying in ${finalDelay}ms...`, error);
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é€šçŸ¥ï¼ˆæ—¢å­˜ã® setStatusMessage ç­‰ãŒã‚ã‚Œã°æ´»ç”¨ï¼‰
        if (showToast && typeof setStatusMessage === 'function') {
          setStatusMessage(`æ··é›‘ã—ã¦ã„ã¾ã™ã€‚${Math.round(finalDelay / 1000)}ç§’å¾Œã«å†è©¦è¡Œã—ã¾ã™... (${attempt}/${maxRetries})`, true);
        } else if (showToast && typeof setDialogSpinner === 'function') {
          setDialogSpinner(` æ··é›‘ä¸­...å†æ¥ç¶š(${attempt})`);
        }
        // æŒ‡å®šæ™‚é–“å¾…æ©Ÿ
        await new Promise(resolve => setTimeout(resolve, finalDelay));
      }
    }
  }

  async function sendExamDataWithRetry() {
    if (!status.isItemChanged) return;
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª
    if (!await confirmDataSave()) return;
    // UIçŠ¶æ…‹ã®åˆæœŸåŒ–
    initializeSendUI();
    // ãƒ‡ãƒ¼ã‚¿åé›†ã¨é€ä¿¡
    try {
      const examData = collectExamData();
      const response = await runGoogleScriptWithRetry('sendExamData', [JSON.stringify(examData), config.studentMailAddress]);
      onExamDataSent(response);
    } catch (error) {
      handleSendError(error);
    }
  }

  async function confirmDataSave() {
    window.onbeforeunload = null;
    return await confirmAsync("ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜", "ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ");
  }

  function initializeSendUI() {
    setDialogSpinner(" å¿—æœ›æ ¡ãƒ‡ãƒ¼ã‚¿é€ä¿¡ä¸­ãƒ»ãƒ»ãƒ»");
    showProgressDialog(true);
    disableSendButton(true);
    disableReportButton(false);
    config.examDataList.length = 0;
  }

  function collectExamData() {
    const examData = [];

    for (let i = 0; i < config.examMaxInputCount; i++) {
      const rowData = createExamDataRow(i + 1);
      if (rowData) {
        examData.push(rowData);
      }
    }

    return examData;
  }

  function createExamDataRow(index) {
    const dcode = dom[`universityCode${index}`].value;
    const isDelete = dom[`examType${index}`].disabled;
    if (!dcode || dcode.length === 0) {
      dom[`universityName${index}`].textContent = '';
      return null;
    }
    return [
      '', // TIME_STAMP
      config.currentStudentData[0], // MAIL_ADDR
      isDelete, // DEL_FLAG
      String(dcode), // DAIGAKU_CODE
      universityMap.get(String(dcode)), // DAIGAKU_NAME
      dom[`result${index}`].value, // GOUHI
      dom[`examType${index}`].value, // KEITAI
      dom[`proceed${index}`].checked // SHINGAKU
    ];
  }

  function handleSendError(error) {
    console.error(error);
    showProgressDialog(false);
    confirmAsync("ã‚¨ãƒ©ãƒ¼", "ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>æ™‚é–“ã‚’ãŠã„ã¦å†åº¦è©¦ã™ã‹ã€å…ˆç”Ÿã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚<br>è©³ç´°: " + error.message);
  }

  function onExamDataSent(strJSON) {
    setSendMessage('');
    status.isItemChanged = false;
    disableSendButton(true);
    showProgressDialog(false);
    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã•ã‚ŒãŸæœ€æ–°ãƒ‡ãƒ¼ã‚¿ã§æ›´æ–°
    if (strJSON) {
      config.examDataList = JSON.parse(strJSON);
      setInputTable();
      // ç™»éŒ²æ•°ã‚’æ›´æ–°ã—ã¦ç”Ÿå¾’ãƒªã‚¹ãƒˆã‚’å†æç”»ï¼ˆæ•™å“¡ãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰
      if (config.userRole === 'teacher') {
        updateStudentRegCountClient(config.studentMailAddress, config.examDataList.length);
        createStudentList();
        setElementHidden(dom.inputSection, true); // é¸æŠãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹ãŸã‚å…¥åŠ›ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’éè¡¨ç¤º
      }
    }
  }

  // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã®ç™»éŒ²æ•°ã‚’æ›´æ–°
  function updateStudentRegCountClient(mailAddr, count) {
    const student = config.allStudentsData.find(s => s[arrDef.STUDENT_DATA.MAIL_ADDR] === mailAddr);
    if (student) {
      student[arrDef.STUDENT_DATA.REG_COUNT] = count;
    }
  }

  function getExamDataList() {
    setDialogSpinner(" å¿—æœ›æ ¡ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­ãƒ»ãƒ»ãƒ»");
    showProgressDialog(true);
    setSendMessage('');
    status.isItemChanged = false;
    google.script.run
      .withSuccessHandler(onExamDataReceived)
      .withFailureHandler(error => {
        console.error(error);
        showProgressDialog(false); // ãã‚‹ãã‚‹ã‚’æ¶ˆã™
        confirmAsync("ã‚¨ãƒ©ãƒ¼", "å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>æ™‚é–“ã‚’ãŠã„ã¦å†åº¦è©¦ã™ã‹ã€å…ˆç”Ÿã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚<br>è©³ç´°: " + error.message);
      })
      .getExamDataList(config.studentMailAddress)
  }

  function onExamDataReceived(strJSON) {
    status.isDeleted = false;
    config.examDataList = JSON.parse(strJSON);
    showProgressDialog(false);
    disableReportButton(false);
    //setElementHidden("selectorSection", true);
    setElementHidden(dom.inputSection, false);
    setInputTable();
    //setInputVisibility("visible");
    if (status.isUniversityCodeLoading === false) disableSearchButton(false);
  }

  //--------------------------------------------------------------------------------
  // èª¿æŸ»æ›¸ç™ºè¡Œé¡˜
  //--------------------------------------------------------------------------------
  async function requestReport() {
    let result = await confirmAsync("ãƒ¡ãƒ¼ãƒ«é€ä¿¡", config.myMailAddress + "<br>ã«ç™ºè¡Œé¡˜ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ");
    if (!result) return;
    setDialogSpinner(" äº¤ä»˜é¡˜PDFä½œæˆä¸­ãƒ»ãƒ»ãƒ»");
    showProgressDialog(true);
    google.script.run
      .withSuccessHandler(onReportCreated)
      .withFailureHandler(error => {
        console.error(error);
        showProgressDialog(false); // ãã‚‹ãã‚‹ã‚’æ¶ˆã™
        confirmAsync("ã‚¨ãƒ©ãƒ¼", "å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>æ™‚é–“ã‚’ãŠã„ã¦å†åº¦è©¦ã™ã‹ã€å…ˆç”Ÿã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚<br>è©³ç´°: " + error.message);
      })
      .sendPdf(config.studentMailAddress);
  }

  function onReportCreated() {
    showProgressDialog(false);
  }

  //--------------------------------------------------------------------------------
  // ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
  //--------------------------------------------------------------------------------
  window.onload = pageLoaded;


</script>