<script>
  //--------------------------------------------------------------------------------
  // グローバルの定義
  //--------------------------------------------------------------------------------
  let myMailAddress = '';
  let userRole = '';
  let inputEnable = false;
  let studentMailAddress = '';
  let STUDENT_DATA = {};
  let EXAM_DATA = {};
  let examMaxInputCount;
  let examTypeOptions = [];
  let resultOptions = [];
  let teacherData = [];
  let allStudentsData = [];
  let currentStudentData = [];
  let examDataList = [];
  let dom = {}; // DOMキャッシュ用


  let universityCodeList = [];
  let isItemChanged = false;
  let isDeleted = false;
  let isUniversityCodeLoading = false;

  // ダイアログ (ブラウザ依存あり)
  const confirmAsync = async (title, message) => {
    if (dom.confirmDialogTitle) dom.confirmDialogTitle.textContent = title;
    if (dom.confirmDialogMessage) dom.confirmDialogMessage.innerHTML = message; // HTMLで記述可
    dom.confirmDialog?.showModal();
    return new Promise(resolve => {
      const eventBase = flag => () => {
        dom.confirmDialog.close();
        dom.confirmDialogButtonYes.removeEventListener("click", okEvent);
        dom.confirmDialogButtonNo.removeEventListener("click", cancelEvent);
        resolve(flag);
      };
      const okEvent = eventBase(true);
      const cancelEvent = eventBase(false);
      dom.confirmDialogButtonYes.addEventListener("click", okEvent);
      dom.confirmDialogButtonNo.addEventListener("click", cancelEvent);
    });
  }


  //================================================================================
  // UI STATE CONTROL
  //================================================================================

  function setElementHidden(elementId, flag) {
    document.getElementById(elementId).classList.toggle('is-hidden', flag);
  }

  function setPdfButtonDisabled(flag) {
    document.querySelectorAll('.button-pdf').forEach(btn => btn.disabled = flag);
  }

  function setSendButtonDisabled(flag) {
    document.querySelectorAll('.button-send').forEach(btn => btn.disabled = flag);
  }

  function setExitButtonHidden(flag) {
    document.querySelectorAll('.button-exit').forEach(btn => btn.classList.toggle('is-hidden', flag));
  }

  function setSendMessage(text) {
    document.querySelectorAll('.button-alert-message').forEach(item => item.textContent = text);
  }

  // 大学データキャッシュのクリア（管理者がデータ更新時に使用）
  function clearUniversityDataCache() {
    try {
      localStorage.removeItem('universityDataCache');
      localStorage.removeItem('universityDataTimestamp');
      //console.log('大学データのキャッシュをクリアしました');
      return true;
    } catch (e) {
      console.warn('キャッシュのクリアに失敗しました:', e);
      return false;
    }
  }

  function cacheDomElements() {
    const ids = [
      "confirmDialogTitle", "confirmDialogMessage", "confirmDialog",
      "confirmDialogButtonYes", "confirmDialogButtonNo", "headerTitle",
      "currentUserName", "classSelectionContainer", "studentNumberSelectionContainer",
      "progressDialogMessageContainer", "inputTableContainer", "progressDialog", "statusMessage",
      "sendFormButton1", "sendFormButton2", "issueReportButton1", "issueReportButton2",
      "searchTableContainer", "searchButton", "keywordInput", "moveLeftButton",
      "moveRightButton", "cancelButton", "searchBackground", "searchBody",
      "examRowTemplate", "sendFormButton1Message", "sendFormButton2Message",
      "displayCountTotal", "displayCountRange", "inputBackground",
      "selectorSection", "inputSection", "classSelectionContainer", "studentNumberSelectionContainer",
      "targetStudentName"
    ];

    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el) dom[id] = el;
    });
  }

  //--------------------------------------------------------------------------------
  // エントリーポイント
  //--------------------------------------------------------------------------------
  function pageLoaded() {
    cacheDomElements();
    window.onbeforeunload = null;

    setDialogSpinner(" 初期データ取得中・・・");
    setElementHidden('selectorSection', true)
    setElementHidden('inputSection', true)
    //setInputVisibility("hidden");
    showProgressDialog(true);
    google.script.run
      .withSuccessHandler(onInitialDataReceived)
      .withFailureHandler(error => {
        console.error(error);
        showProgressDialog(false); // くるくるを消す
        confirmAsync("エラー", "処理に失敗しました。<br>時間をおいて再度試すか、先生に連絡してください。<br>詳細: " + error.message);
      })
      .getInitialData();
  }

  function onInitialDataReceived(strJSON) {
    const allData = JSON.parse(strJSON) || {};
    myMailAddress = allData.myMailAddress || "";
    STUDENT_DATA = allData.studentStructure || {};
    EXAM_DATA = allData.examStructure || {};
    userRole = allData.userRole || "",
      examMaxInputCount = allData.examMaxCount || 0;
    examTypeOptions = allData.examTypeOptions || [];
    resultOptions = allData.resultOptions || [];
    teacherData = padRowsWithHeader(allData.teacherData || [])[0] || [];
    currentStudentData = padRowsWithHeader(allData.studentData || [])[0] || [];
    examDataList = padRowsWithHeader(allData.examData || []);
    setEventListeners();
    disableSendButton(true);

    const headerTitleEl = dom.headerTitle;
    if (headerTitleEl) headerTitleEl.textContent = allData.headerTitle;


    if (allData.userRole == 'teacher') {
      // 教員モード：生徒一覧を非同期で取得
      setMyName("【教員モード】" + teacherData[1]);
      disableReportButton(true);
      setElementHidden('selectorSection', false);
      setElementHidden("inputSection", true);
      setDialogSpinner(" 【教員モード】生徒一覧取得中・・・");
      // 生徒一覧を非同期で取得
      google.script.run
        .withSuccessHandler(studentsJSON => {
          allStudentsData = padRowsWithHeader(JSON.parse(studentsJSON) || []);
          showProgressDialog(false);
          showSelector();
        })
        .withFailureHandler(error => {
          console.error(error);
          showProgressDialog(false);
          confirmAsync("エラー", "生徒データの取得に失敗しました。<br>詳細: " + error.message);
        })
        .getStudentsList();

      getUniversityDataList();
    } else if (allData.userRole == 'student') {
      setDialogSpinner(` ようこそ、${currentStudentData[STUDENT_DATA.NAME]}さん`);
      setMyName(currentStudentData[STUDENT_DATA.NAME]);
      inputEnable = allData.inputEnable;
      if (inputEnable == false) {
        showProgressDialog(false);
        confirmAsync("情報", "現在、管理者により入力が禁止されています。");
        return;
      }
      studentMailAddress = currentStudentData[STUDENT_DATA.MAIL_ADDR]
      setStudentData("targetStudentName");
      setElementHidden('selectorSection', true);
      setElementHidden('inputSection', false);
      setInputTable(); // 空のテーブルを先に表示

      // 受験データローディング中のメッセージを表示
      //setDialogSpinner(" 志望校データ読込中・・・");
      setDialogSpinner(`ようこそ、${currentStudentData[STUDENT_DATA.NAME]} さん`);

      // 受験データを非同期で取得
      google.script.run
        .withSuccessHandler(examJSON => {
          examDataList = padRowsWithHeader(JSON.parse(examJSON) || []);
          setInputTable(); // データを反映
          showProgressDialog(false);
          //console.log('受験データの取得が完了しました');
        })
        .withFailureHandler(error => {
          console.error(error);
          showProgressDialog(false);
          confirmAsync("エラー", "受験データの取得に失敗しました。<br>詳細: " + error.message);
        })
        .getExamDataList();

      getUniversityDataList();
    } else {

      showProgressDialog(false);
      confirmAsync("警告", "入力が許可されていません。<br>管理者に問い合わせてください。");
      return;
    }
  }

  function setMyName(name) {
    const myNameDiv = dom.currentUserName;
    myNameDiv.textContent = name;
  }

  //--------------------------------------------------------------------------------
  // 教員ページ生徒選択
  //--------------------------------------------------------------------------------
  function showSelector() {
    const classes = Array.from(new Set(allStudentsData.map(arr => arr[STUDENT_DATA.CLASS])));
    classes.sort(); // クラス名でソート
    createClassSelector(classes);
  }

  function createClassSelector(arr) {
    // クラス一覧リストボックス
    const selClassDiv = dom.classSelectionContainer;
    selClassDiv.replaceChildren(); // または selClassDiv.innerHTML = '';

    const label = document.createTextNode('クラス： ');
    selClassDiv.appendChild(label);
    const selectEl = document.createElement('select');
    selectEl.id = 'classSelect';
    dom.classSelect = selectEl;
    selectEl.addEventListener('change', createStudentList);
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = '選択';
    defaultOption.selected = true;
    defaultOption.disabled = false;
    selectEl.appendChild(defaultOption);
    arr.forEach(className => { // クラスのリストから <option> 要素を生成して追加
      const option = document.createElement('option');
      option.value = className;
      option.textContent = className + '組';
      selectEl.appendChild(option);
    });
    selClassDiv.appendChild(selectEl);
  }

  function createStudentList() { // 選択されたクラスの生徒一覧生成
    setElementHidden("inputSection", true);
    const selClassId = dom.classSelect;
    const selClass = selClassId.value;
    const students = allStudentsData.filter(row => row[STUDENT_DATA.CLASS] == selClass);
    const selNumDiv = dom.studentNumberSelectionContainer;
    selNumDiv.replaceChildren();

    const label = document.createTextNode('番号：氏名 ');
    selNumDiv.appendChild(label);
    const selectEl = document.createElement('select');
    selectEl.id = 'studentSelectorInput';
    dom.studentSelectorInput = selectEl;
    selectEl.addEventListener('change', handleStudentSelect);
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = '選択';
    defaultOption.selected = true;
    defaultOption.disabled = false;
    selectEl.appendChild(defaultOption);
    students.forEach(student => {
      const option = document.createElement('option');
      option.value = student[STUDENT_DATA.MAIL_ADDR];
      let strNum = ('0' + student[STUDENT_DATA.NUMBER] + '：').slice(-3);
      option.textContent = strNum + student[STUDENT_DATA.NAME];
      selectEl.appendChild(option);
    });
    selNumDiv.appendChild(selectEl);
  }

  async function handleStudentSelect() {
    try {
      if (isItemChanged && !await confirmAsync("確認", "変更を保存せずに移動してよろしいですか")) {
        return;
      }
      const selectEl = dom.studentSelectorInput;
      const mailAddr = selectEl.value;

      if (mailAddr.length == 0) {
        return;
      }

      currentStudentData = allStudentsData.find(row => row[0] == mailAddr)
      studentMailAddress = mailAddr;

      setStudentData("targetStudentName");
      getExamDataList()
    } catch (e) {
      console.error("error in handleStudentSelect", e);
    }
  }

  //--------------------------------------------------------------------------------
  // その他
  //--------------------------------------------------------------------------------
  function setDialogSpinner(text) {
    const idStatusMsg = dom.progressDialogMessageContainer;
    idStatusMsg.replaceChildren();

    if (text.length) {
      const divSpinner = document.createElement("div");
      divSpinner.className = "span-spinner-big"
      idStatusMsg.append(divSpinner)
      const divMessage = document.createElement("div");
      divMessage.textContent = text
      idStatusMsg.append(divMessage)
    }
  }

  function disableScroll(event) {
    event.preventDefault();
  }

  function setInputVisibility(vis) {
    dom.inputTableContainer.style.visibility = vis;
  }


  function showProgressDialog(vis) {
    if (vis) {
      if (!dom.progressDialog.open) dom.progressDialog.showModal();
    } else {
      dom.progressDialog.close(); // 削除の確認
    }

  }

  //--------------------------------------------------------------------------------
  // 大学コード取得
  //--------------------------------------------------------------------------------
  const universityMap = new Map;

  function getUniversityDataList() {
    const CACHE_KEY = 'universityDataCache';
    const CACHE_TIMESTAMP_KEY = 'universityDataTimestamp';
    const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24時間

    // キャッシュの確認
    try {
      const cachedData = localStorage.getItem(CACHE_KEY);
      const cachedTimestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);

      if (cachedData && cachedTimestamp) {
        const age = Date.now() - parseInt(cachedTimestamp);
        if (age < CACHE_DURATION) {
          //console.log('大学データをキャッシュから取得しました');
          // キャッシュから取得する場合も、ローディング状態を設定
          isUniversityCodeLoading = true;
          disableSearchButton(true);
          setStatusMessage('大学コード取得中．．．');
          onUniversityDataReceived(cachedData);
          return;
        } else {
          console.warn('キャッシュの有効期限が切れています');
        }
      }
    } catch (e) {
      console.warn('localStorageへのアクセスに失敗しました:', e);
      // キャッシュが使えない場合は通常通りサーバーから取得
    }

    // キャッシュがない、または期限切れの場合はサーバーから取得
    isUniversityCodeLoading = true;
    disableSearchButton(true);
    setStatusMessage('大学コード取得中．．．')
    google.script.run
      .withSuccessHandler(str => {
        // キャッシュに保存
        try {
          localStorage.setItem(CACHE_KEY, str);
          localStorage.setItem(CACHE_TIMESTAMP_KEY, Date.now().toString());
          //console.log('大学データをキャッシュに保存しました');
        } catch (e) {
          console.warn('localStorageへの保存に失敗しました:', e);
        }
        onUniversityDataReceived(str);
      })
      .withFailureHandler(error => {
        console.error(error);
        showProgressDialog(false); // くるくるを消す
        confirmAsync("エラー", "処理に失敗しました。<br>時間をおいて再度試すか、先生に連絡してください。<br>詳細: " + error.message);
      })
      .getUniversityDataList();
  }

  function onUniversityDataReceived(str) {
    universityCodeList = JSON.parse(str) || [];
    universityCodeList.forEach(drow => universityMap.set(String(drow[0]), drow[1]));
    isUniversityCodeLoading = false;
    disableSearchButton(false);
    setStatusMessage('');
  }

  function setStatusMessage(text) {
    const idStatusMsg = dom.statusMessage;
    idStatusMsg.innerHTML = '';

    if (text.length) {
      const spanSpinner = document.createElement("span");
      spanSpinner.className = "span-spinner"
      idStatusMsg.append(spanSpinner)
      idStatusMsg.append(text)
    }
  }

  function disableSearchButton(flag) {
    const buttons = document.querySelectorAll('.search-button');
    buttons.forEach(button => {
      button.disabled = flag;
    });
    const texts = document.querySelectorAll('.university-code');
    texts.forEach(text => {
      text.disabled = flag;
    });
  }

  function setEventListeners() {
    // イベントリスナー:jukentable全体にリスナーを設定
    const inputTableContainer = dom.inputTableContainer;
    inputTableContainer.addEventListener('click', (event) => {
      const target = event.target;
      if (target.classList.contains('search-button')) {
        const row = target.closest('tr'); // ボタンが所属する行を取得
        const rank = row.querySelector('.rank-cell').textContent;
        searchUniversityCode(rank);
      }
      if (target.classList.contains('clear-button')) {
        const row = target.closest('tr');
        const rank = row.querySelector('.rank-cell').textContent;
        clearRow(rank);
      }
      if (target.classList.contains('proceed-radio')) {
        onProceedRadioClicked(target);
      }
    });
    inputTableContainer.addEventListener('change', (event) => {
      const target = event.target;
      setItemChanged();
      if (target.classList.contains('university-code')) { // 大学コードが変更された
        const row = target.closest('tr');
        const rank = row.querySelector('.rank-cell').textContent;
        setUniversityName('universityCode' + rank);
      }
    });
    // 受験校テーブルのボタン
    dom.sendFormButton1.addEventListener("click", sendExamData);
    dom.sendFormButton2.addEventListener("click", sendExamData);
    dom.issueReportButton1.addEventListener("click", requestReport);
    dom.issueReportButton2.addEventListener("click", requestReport);
    //document.getElementById("cancelButton1").addEventListener("click", showSelector);
    //document.getElementById("cancelButton2").addEventListener("click", showSelector);
    // searchtable全体にリスナーを設定
    const searchTableDiv = dom.searchTableContainer;

    searchTableDiv.addEventListener('click', (event) => {
      const target = event.target;
      if (target.classList.contains('select-button')) {
        const row = target.closest('tr');
        const dcode = row.dataset.dcode
        setUniversityCode(dcode);
      }
    });
    // 検索テーブルのボタン
    dom.searchButton.addEventListener("click", () => { displayStart = 0; searchKeyword(); }); // 先頭から表示
    dom.keywordInput.addEventListener("input", () => { displayStart = 0; searchKeyword(); }); // 先頭から表示
    dom.moveLeftButton.addEventListener('click', () => { displayStart -= displayStep; searchKeyword(); }) // 前のページへ
    dom.moveRightButton.addEventListener('click', () => { displayStart += displayStep; searchKeyword(); }); // 次のページへ
    dom.cancelButton.addEventListener("click", cancelSearch);
    dom.searchBackground.addEventListener('click', cancelSearch);
    dom.searchBody.addEventListener('click', (event) => { event.stopPropagation(); });

    // スクロール位置の取得
    window.addEventListener('scroll', () => { currentY = window.scrollY; currentX = window.scrollX; });
  }

  //--------------------------------------------------------------------------------
  // 入力用テーブル関連
  //--------------------------------------------------------------------------------
  let selectedProceedRadioId = ""; // 選択されている進学先ラジオボタンのID

  function setStudentData(id) {
    let str = '';
    str += (currentStudentData?.[STUDENT_DATA.GRADE] || "") + '年 ';
    str += (currentStudentData?.[STUDENT_DATA.CLASS] || "") + '組 ';
    str += (currentStudentData?.[STUDENT_DATA.NUMBER] || "") + '番 氏名 ';
    str += (currentStudentData?.[STUDENT_DATA.NAME] || "");
    if (dom[id]) dom[id].textContent = str;
  }


  function disableReportButton(flag) {
    dom.issueReportButton1.disabled = flag;
    dom.issueReportButton2.disabled = flag;

  }
  function disableSendButton(flag) {
    dom.sendFormButton1.disabled = flag;
    dom.sendFormButton2.disabled = flag;
  }

  function setSendMessage(text) {
    dom.sendFormButton1Message.textContent = text;
    dom.sendFormButton2Message.textContent = text;
  }


  // 入力用テーブル生成
  function setInputTable() {
    // テーブル本体
    const template = dom.examRowTemplate;

    const tableBody = document.createElement('tbody');

    for (let i = 0; i < examMaxInputCount; i++) {
      const rowClone = template.content.cloneNode(true);
      const hasData = i < examDataList.length;
      const jukenItem = hasData ? examDataList[i] : null; // データがあれば取得、なければnull
      const dcode = rowClone.querySelector('.university-code');
      const dname = rowClone.querySelector('.university-name');
      const keitaiCell = rowClone.querySelector('.exam-type-select-cell');
      const gouhiCell = rowClone.querySelector('.result-select-cell');
      const shingakuRadio = rowClone.querySelector('.proceed-radio');
      const searchBtn = rowClone.querySelector('.search-button');
      const clearBtn = rowClone.querySelector('.clear-button');
      rowClone.querySelector('.rank-cell').textContent = i + 1;
      dcode.id = 'universityCode' + (i + 1);
      dname.id = 'universityName' + (i + 1);
      shingakuRadio.id = 'proceed' + (i + 1);
      searchBtn.id = 'searchButton' + (i + 1);
      clearBtn.id = 'deleteButton' + (i + 1);

      dom['universityCode' + (i + 1)] = dcode;
      dom['universityName' + (i + 1)] = dname;
      dom['proceed' + (i + 1)] = shingakuRadio;
      dom['searchButton' + (i + 1)] = searchBtn;
      dom['deleteButton' + (i + 1)] = clearBtn;

      if (hasData) {
        dcode.value = jukenItem[EXAM_DATA.DAIGAKU_CODE];
        dname.textContent = jukenItem[EXAM_DATA.DAIGAKU_NAME];
        keitaiCell.appendChild(createExamTypeSelect(i, jukenItem[EXAM_DATA.KEITAI]));
        gouhiCell.appendChild(createResultSelect(i, jukenItem[EXAM_DATA.GOUHI]));
        if (String(jukenItem[EXAM_DATA.SHINGAKU]).toUpperCase() === "TRUE") {
          shingakuRadio.checked = true;
          selectedProceedRadioId = shingakuRadio.id;
        }
      } else {
        keitaiCell.appendChild(createExamTypeSelect(i, ""));
        gouhiCell.appendChild(createResultSelect(i, ""));
      }
      tableBody.appendChild(rowClone);
    }
    const tr = document.createElement("tr");
    tr.classList.add("thead-row");
    tr.classList.add("table-header-row");
    // ヘッダーの配列
    const headers = [
      "No",
      "大学コード",
      "学校名・学部・学科・方式・日程",
      "試験形態",
      "合否",
      "進学",
      "削除"
    ];
    headers.forEach((text, i) => {
      const th = document.createElement("th");
      th.textContent = text;
      tr.appendChild(th);
    });
    const tHead = document.createElement('thead');
    tHead.appendChild(tr);
    const table = document.createElement('table');
    table.classList.add('input-table');
    table.appendChild(tHead);
    table.appendChild(tableBody);
    const inputTableContainer = dom.inputTableContainer;
    inputTableContainer.replaceChildren();
    inputTableContainer.appendChild(table);

    // 大学データが既にロードされている場合は、ボタンを有効にする
    if (isUniversityCodeLoading == false && universityCodeList.length > 0) {
      disableSearchButton(false);
    }
  }


  function checkDuplicate(inputId) {
    const input = dom[inputId];
    for (let i = 0; i < examMaxInputCount; i++) {
      let id = 'universityCode' + (i + 1);
      const ddata = dom[id];

      if (ddata != input) {
        if (input.value.trim() == ddata.value.trim()) {
          return i + 1;
        }
      }
    }
    return 0;
  }

  function setUniversityName(dn) {
    const dcodeSpan = dom[dn];
    const dcode = dcodeSpan.value.trim();
    const dnameSpan = dom[dn.replace('universityCode', 'universityName')];


    if (dcode.length == 0) {
      dnameSpan.innerHTML = '';
      return;
    }
    const row = checkDuplicate(dn);
    if (row > 0) {
      dnameSpan.innerHTML = `<span style="color:red;">${dcode}は志望校${row}と重複しています</span>`;
      dcodeSpan.value = ''; // 不正なコードをクリア              
      return;
    }
    const dname = universityMap.get(dcode);
    if (dname) {
      dnameSpan.textContent = dname;
    } else {
      dnameSpan.innerHTML = `<span style="color:red;">コードに誤りがあります</span>`;
      dcodeSpan.value = ''; // 不正なコードをクリア
    }
  }

  function createExamTypeSelect(i, selectedValue) {
    const select = document.createElement('select');
    select.name = 'examType' + (i + 1);
    select.id = 'examType' + (i + 1);
    dom['examType' + (i + 1)] = select;


    examTypeOptions.forEach(optionValue => {
      const option = document.createElement('option');
      option.value = optionValue;
      option.textContent = optionValue;
      if (optionValue === selectedValue) {
        option.selected = true;
      }
      select.appendChild(option);
    });
    return select;
  }

  function createResultSelect(i, selectedValue) {
    const select = document.createElement('select');
    select.name = 'result' + (i + 1);
    select.id = 'result' + (i + 1);
    dom['result' + (i + 1)] = select;


    resultOptions.forEach(optionValue => {
      const option = document.createElement('option');
      option.value = optionValue;
      option.textContent = optionValue;
      if (optionValue === selectedValue) {
        option.selected = true;
      }
      select.appendChild(option);
    });
    return select;
  }

  async function clearRow(i) {
    let result = await confirmAsync("削除/復元", "志望校 " + i + " を変更しますか？");
    if (result) {
      const idc = dom["universityCode" + i];
      const idb = dom["searchButton" + i];
      const idn = dom["universityName" + i];
      const idk = dom["examType" + i];
      const idr = dom["result" + i];
      const ids = dom["proceed" + i];
      const arrid = [idc, idb, idn, idk, idr, ids];
      const idd = dom["deleteButton" + i];

      if (idk.disabled == false) { // idc, idnは大学コード読み込み前は disable
        arrid.forEach(id => {
          id.disabled = true;
          id.style.textDecoration = "line-through";
          id.style.opacity = 0.6;
        });
        idd.textContent = "戻す";
      } else {
        arrid.forEach(id => {
          id.disabled = false;
          id.style.textDecoration = "none";
          id.style.opacity = 1;
          //id.style.color = "#000";
          //id.style.backgroundColor = "#FFF";
        });
        idd.textContent = "削除";
      }
      setItemChanged();
    }
  }

  function onProceedRadioClicked(radioItem) {
    if (radioItem.id == selectedProceedRadioId) {
      radioItem.checked = false; // 選択を解除
      selectedProceedRadioId = ""; // 選択状態をクリア
      setItemChanged();
    } else {
      selectedProceedRadioId = radioItem.id;
    }
  }

  function setItemChanged() {
    if (!isItemChanged) {
      isItemChanged = true;
      disableSendButton(false);
      disableReportButton(true);
      setSendMessage('変更有→')
      window.onbeforeunload = function (e) {
        e.returnValue = "変更を保存せずに移動します。よろしいですか？";
      }
    }
  }
  //--------------------------------------------------------------------------------
  // 大学コードテーブル関連
  //--------------------------------------------------------------------------------
  let currentRow = 0; // 大学検索を呼び出した行
  let currentY = 0; //現在のスクロール位置
  let currentX = 0;
  let inputPosY = 0; // inputテーブル現在のスクロール位置
  let inputPosX = 0;
  let searchPosY = 0; // inputテーブル現在のスクロール位置
  let searchPosX = 0;

  function toggleSearchDisplay(flag) {
    if (flag) {
      inputPosY = currentY;
      inputPosX = currentX;
      window.scrollTo(searchPosX, searchPosY);
      setElementHidden('searchBackground', false);
      setElementHidden('inputBackground', true);
      //document.getElementById("searchBackground").style.display = "block";
      //document.getElementById("inputBackground").style.display = "none";
    } else {
      searchPosY = currentY;
      searchPosX = currentX;
      window.scrollTo(inputPosX, inputPosY);
      setElementHidden('searchBackground', true);
      setElementHidden('inputBackground', false);
      //document.getElementById("searchBackground").style.display = "none";
      //document.getElementById("inputBackground").style.display = "block";
    }
  }

  function searchUniversityCode(row) {
    currentRow = row;
    toggleSearchDisplay(true);
    displayStart = 0;
    searchKeyword();
  }

  // 最後の入力から指定時間後に処理を実行する「デバウンス」関数
  let debounceTimer;

  function debounce(func, delay) {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(func, delay);
  }

  let displayStart = 0;
  const displayStep = 50;

  function searchKeyword() {
    // デバウンス処理を挟む
    debounce(() => {
      const keywordInput = dom.keywordInput.value;
      const keywords = keywordInput.replace(/　/g, ' ').split(' ').filter(kw => kw); // 空のキーワードを除外
      const dcTotal = dom.displayCountTotal;
      const dcRange = dom.displayCountRange;
      const resultsContainer = dom.searchTableContainer;
      resultsContainer.replaceChildren(); // 前回の検索結果をクリア
      const filteredData = universityCodeList.filter(row =>
        keywords.every(kw => (row[1] || "").includes(kw) || String(row[0] || "").includes(kw))
      );
      const limitedData = filteredData.slice(displayStart, displayStart + displayStep);
      const total = filteredData.length;
      const moveLeft = dom.moveLeftButton;
      const moveRight = dom.moveRightButton;

      moveLeft.disabled = (displayStart <= 0);
      moveRight.disabled = (displayStart + displayStep >= total);
      const dend = total > displayStart + displayStep ? displayStart + displayStep : total
      dcRange.textContent = ` ${displayStart + 1} ～ ${dend} `;
      dcTotal.textContent = ` ／ ${total} 件`;
      // 2. 検索結果テーブルの作成
      const table = document.createElement('table');
      table.classList.add('search-table');
      // テーブルヘッダーの作成
      const tableHead = table.createTHead();
      const headerRow = tableHead.insertRow();
      headerRow.classList.add('table-header-row');
      const headers = ['学校名・学部・学科・入試方式・日程', '大学コード', '選択'];
      headers.forEach(text => {
        const th = document.createElement('th');
        th.textContent = text;
        headerRow.appendChild(th);
      });
      const tableBody = table.createTBody();
      tableBody.id = "searchTable";
      limitedData.forEach(dataRow => {
        const code = dataRow[0];
        const name = dataRow[1];
        const tr = tableBody.insertRow();
        tr.classList.add("result-row");
        tr.dataset.dcode = dataRow[0];
        tr.dataset.dname = dataRow[1];
        // 学校名セル
        const nameCell = tr.insertCell();
        nameCell.textContent = name;
        nameCell.dataset.label = "学校名等："; // レスポンシブ対応のラベル
        // 大学コードセル
        const codeCell = tr.insertCell();
        codeCell.dataset.label = "コード：";
        codeCell.classList.add("text-center");
        const codeInput = document.createElement('input');
        codeInput.type = 'text';
        codeInput.value = code;
        codeInput.readOnly = true;
        codeInput.size = 10;
        codeCell.appendChild(codeInput);
        // 選択ボタンセル
        const buttonCell = tr.insertCell();
        buttonCell.classList.add("text-center");
        const selectButton = document.createElement('button');
        selectButton.textContent = '選択';
        selectButton.classList.add("select-button");
        buttonCell.appendChild(selectButton);
      });
      resultsContainer.appendChild(table);
    }, 1000);
  }

  function setUniversityCode(dcode) {
    const dcodeSpan = dom['universityCode' + currentRow];

    dcodeSpan.value = String(dcode);
    setUniversityName('universityCode' + currentRow);
    setItemChanged();
    cancelSearch(); // 検索画面を閉じる
  }

  function cancelSearch() {
    toggleSearchDisplay(false);
  }

  //--------------------------------------------------------------------------------
  // データ送信
  //--------------------------------------------------------------------------------
  let isReloadRequired;

  async function sendExamData() {
    if (!isItemChanged) return;
    window.onbeforeunload = null;
    let result = await confirmAsync("データの保存", "データを送信しますか？");
    if (!result) return;
    setDialogSpinner(" 志望校データ送信中・・・")
    showProgressDialog(true);
    disableSendButton(true);
    disableReportButton(false);
    examDataList.length = 0;
    isReloadRequired = false;
    for (let i = 0; i < examMaxInputCount; i++) {
      const dcode = dom['universityCode' + (i + 1)].value;
      const isDelete = dom['examType' + (i + 1)].disabled;
      if (isDelete) isReloadRequired = true;
      if (dcode || dcode.length > 0) {
        let rowData = [];
        rowData[EXAM_DATA.TIME_STAMP] = '';
        rowData[EXAM_DATA.MAIL_ADDR] = currentStudentData[0];
        rowData[EXAM_DATA.DEL_FLAG] = isDelete;
        rowData[EXAM_DATA.DAIGAKU_CODE] = String(dcode);
        rowData[EXAM_DATA.DAIGAKU_NAME] = universityMap.get(String(dcode));
        rowData[EXAM_DATA.GOUHI] = dom['result' + (i + 1)].value;
        rowData[EXAM_DATA.KEITAI] = dom['examType' + (i + 1)].value;
        rowData[EXAM_DATA.SHINGAKU] = dom['proceed' + (i + 1)].checked;
        examDataList.push(rowData);
      } else {
        dom['universityName' + (i + 1)].textContent = '';
      }

    }
    const strJuken = JSON.stringify(examDataList);
    google.script.run
      .withSuccessHandler(onExamDataSent)
      .withFailureHandler(error => {
        console.error(error);
        showProgressDialog(false); // くるくるを消す
        confirmAsync("エラー", "処理に失敗しました。<br>時間をおいて再度試すか、先生に連絡してください。<br>詳細: " + error.message);
      })
      .saveExamDataList(strJuken, studentMailAddress);
  }

  function onExamDataSent() {
    setSendMessage('');
    isItemChanged = false;
    disableSendButton(true);
    showProgressDialog(false);
    if (isReloadRequired) {
      getExamDataList();
    }
  }

  function getExamDataList() {
    setDialogSpinner(" 志望校データ取得中・・・");
    showProgressDialog(true);
    setSendMessage('');
    isItemChanged = false;
    google.script.run
      .withSuccessHandler(onExamDataReceived)
      .withFailureHandler(error => {
        console.error(error);
        showProgressDialog(false); // くるくるを消す
        confirmAsync("エラー", "処理に失敗しました。<br>時間をおいて再度試すか、先生に連絡してください。<br>詳細: " + error.message);
      })
      .getExamDataList(studentMailAddress)
  }

  function onExamDataReceived(strJSON) {
    isDeleted = false;
    examDataList = JSON.parse(strJSON)
    showProgressDialog(false);
    disableReportButton(false);
    //setElementHidden("selectorSection", true);
    setElementHidden("inputSection", false);
    setInputTable();
    //setInputVisibility("visible");
    if (isUniversityCodeLoading == false) disableSearchButton(false);
  }

  //--------------------------------------------------------------------------------
  // 調査書発行願
  //--------------------------------------------------------------------------------
  async function requestReport() {
    let result = await confirmAsync("メール送信", myMailAddress + "<br>に発行願を送信しますか？");
    if (!result) return;
    setDialogSpinner(" 交付願PDF作成中・・・");
    showProgressDialog(true);
    google.script.run
      .withSuccessHandler(onReportCreated)
      .withFailureHandler(error => {
        console.error(error);
        showProgressDialog(false); // くるくるを消す
        confirmAsync("エラー", "処理に失敗しました。<br>時間をおいて再度試すか、先生に連絡してください。<br>詳細: " + error.message);
      })
      .sendPdf(studentMailAddress);
  }

  function onReportCreated() {
    showProgressDialog(false);
  }

  //--------------------------------------------------------------------------------
  // エントリーポイント
  //--------------------------------------------------------------------------------
  window.onload = pageLoaded;

  //--------------------------------------------------------------------------------
  // データ補正ヘルパー (APIの行末欠損対策：ヘッダー基準)
  //--------------------------------------------------------------------------------
  function padRowsWithHeader(rows) {
    if (!Array.isArray(rows) || rows.length === 0) return [];

    // 1行目をヘッダーとして扱い、その長さを基準にする
    const header = rows[0];
    const headerLength = header.length;

    // 2行目以降のデータ部分を取得
    const dataRows = rows.slice(1);

    // データ部分に対してパディングを適用
    return dataRows.map(row => {
      if (!Array.isArray(row)) return row;
      while (row.length < headerLength) {
        row.push("");
      }
      return row;
    });
  }
</script>