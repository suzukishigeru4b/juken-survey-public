<script>
  // çµµæ–‡å­—ã®æº–å‚™ â†©ï¸ ğŸ—‘ ğŸ’¾ ğŸ” âœ…
  //--------------------------------------------------------------------------------
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã®å®šç¾©
  //--------------------------------------------------------------------------------
  let myMailAddress = '';
  let userRole = '';
  let inputEnable = false;
  let studentMailAddress = '';
  let STUDENT_DATA = {};
  let EXAM_DATA = {};
  let examMaxInputCount;
  let examTypeOptions = [];
  let resultOptions = [];
  let teacherData = [];
  let allStudentsData = [];
  let currentStudentData = [];
  let examDataList = [];
  let dom = {}; // DOMã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨


  let universityCodeList = [];
  let isItemChanged = false;
  let isDeleted = false;
  let isUniversityCodeLoading = false;

  // ãƒ€ã‚¤ã‚¢ãƒ­ã‚° (ãƒ–ãƒ©ã‚¦ã‚¶ä¾å­˜ã‚ã‚Š)
  const confirmAsync = async (title, message) => {
    if (dom.confirmDialogTitle) dom.confirmDialogTitle.textContent = title;
    if (dom.confirmDialogMessage) dom.confirmDialogMessage.innerHTML = message; // HTMLã§è¨˜è¿°å¯
    dom.confirmDialog?.showModal();
    return new Promise(resolve => {
      const eventBase = flag => () => {
        dom.confirmDialog.close();
        dom.confirmDialogButtonYes.removeEventListener("click", okEvent);
        dom.confirmDialogButtonNo.removeEventListener("click", cancelEvent);
        resolve(flag);
      };
      const okEvent = eventBase(true);
      const cancelEvent = eventBase(false);
      dom.confirmDialogButtonYes.addEventListener("click", okEvent);
      dom.confirmDialogButtonNo.addEventListener("click", cancelEvent);
    });
  }


  //================================================================================
  // UI STATE CONTROL
  //================================================================================

  function setElementHidden(elementId, flag) {
    document.getElementById(elementId).classList.toggle('is-hidden', flag);
  }

  function setPdfButtonDisabled(flag) {
    document.querySelectorAll('.button-pdf').forEach(btn => btn.disabled = flag);
  }

  function setSendButtonDisabled(flag) {
    document.querySelectorAll('.button-send').forEach(btn => btn.disabled = flag);
  }

  function setExitButtonHidden(flag) {
    document.querySelectorAll('.button-exit').forEach(btn => btn.classList.toggle('is-hidden', flag));
  }

  function setSendMessage(text) {
    document.querySelectorAll('.button-alert-message').forEach(item => item.textContent = text);
  }

  // å¤§å­¦ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚¯ãƒªã‚¢ï¼ˆç®¡ç†è€…ãŒãƒ‡ãƒ¼ã‚¿æ›´æ–°æ™‚ã«ä½¿ç”¨ï¼‰
  function clearUniversityDataCache() {
    try {
      localStorage.removeItem('universityDataCache');
      localStorage.removeItem('universityDataTimestamp');
      //console.log('å¤§å­¦ãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
      return true;
    } catch (e) {
      console.warn('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚¯ãƒªã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
      return false;
    }
  }

  function cacheDomElements() {
    const ids = [
      "confirmDialogTitle", "confirmDialogMessage", "confirmDialog",
      "confirmDialogButtonYes", "confirmDialogButtonNo", "headerTitle",
      "currentUserName", "classSelectionContainer", "studentNumberSelectionContainer",
      "progressDialogMessageContainer", "inputTableContainer", "progressDialog", "statusMessage",
      "statusMessage2", "sendFormButton1", "sendFormButton2", "issueReportButton1", "issueReportButton2",
      "searchTableContainer", "searchButton", "keywordInput", "moveLeftButton",
      "moveRightButton", "cancelButton", "searchBackground", "searchBody",
      "examRowTemplate", "sendFormButton1Message", "sendFormButton2Message",
      "displayCountTotal", "displayCountRange", "inputBackground",
      "selectorSection", "inputSection", "classSelectionContainer", "studentNumberSelectionContainer",
      "targetStudentName"
    ];

    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el) dom[id] = el;
    });
  }

  //--------------------------------------------------------------------------------
  // ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
  //--------------------------------------------------------------------------------
  function pageLoaded() {
    cacheDomElements();
    window.onbeforeunload = null;

    setDialogSpinner(" åˆæœŸãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­ãƒ»ãƒ»ãƒ»");
    setElementHidden('selectorSection', true)
    setElementHidden('inputSection', true)
    //setInputVisibility("hidden");
    showProgressDialog(true);
    google.script.run
      .withSuccessHandler(onInitialDataReceived)
      .withFailureHandler(error => {
        console.error(error);
        showProgressDialog(false); // ãã‚‹ãã‚‹ã‚’æ¶ˆã™
        confirmAsync("ã‚¨ãƒ©ãƒ¼", "å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>æ™‚é–“ã‚’ãŠã„ã¦å†åº¦è©¦ã™ã‹ã€å…ˆç”Ÿã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚<br>è©³ç´°: " + error.message);
      })
      .getInitialData();
  }

  function onInitialDataReceived(strJSON) {
    const allData = JSON.parse(strJSON) || {};
    myMailAddress = allData.myMailAddress || "";
    STUDENT_DATA = allData.studentStructure || {};
    EXAM_DATA = allData.examStructure || {};
    userRole = allData.userRole || "",
      examMaxInputCount = allData.examMaxCount || 0;
    examTypeOptions = allData.examTypeOptions || [];
    resultOptions = allData.resultOptions || [];
    teacherData = padRowsWithHeader(allData.teacherData || [])[0] || [];
    currentStudentData = padRowsWithHeader(allData.studentData || [])[0] || [];
    examDataList = padRowsWithHeader(allData.examData || []);
    setEventListeners();
    disableSendButton(true);

    const headerTitleEl = dom.headerTitle;
    if (headerTitleEl) headerTitleEl.textContent = allData.headerTitle;


    if (allData.userRole == 'teacher') {
      // æ•™å“¡ãƒ¢ãƒ¼ãƒ‰ï¼šç”Ÿå¾’ä¸€è¦§ã‚’éåŒæœŸã§å–å¾—
      setMyName("ã€æ•™å“¡ãƒ¢ãƒ¼ãƒ‰ã€‘" + teacherData[1]);
      disableReportButton(true);
      setElementHidden('selectorSection', false);
      setElementHidden("inputSection", true);
      showProgressDialog(false);
      setStatusMessage2(" ã€æ•™å“¡ãƒ¢ãƒ¼ãƒ‰ã€‘ç”Ÿå¾’ä¸€è¦§å–å¾—ä¸­ãƒ»ãƒ»ãƒ»");
      // ç”Ÿå¾’ä¸€è¦§ã‚’éåŒæœŸã§å–å¾—
      google.script.run
        .withSuccessHandler(studentsJSON => {
          allStudentsData = padRowsWithHeader(JSON.parse(studentsJSON) || []);
          setStatusMessage2("");
          showSelector();
        })
        .withFailureHandler(error => {
          console.error(error);
          setStatusMessage2("");
          confirmAsync("ã‚¨ãƒ©ãƒ¼", "ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>è©³ç´°: " + error.message);
        })
        .getStudentsList();

      getUniversityDataList();
    } else if (allData.userRole == 'student') {
      showProgressDialog(false);
      setStatusMessage2(` å—é¨“æ ¡ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...`);
      setMyName(currentStudentData[STUDENT_DATA.NAME]);
      inputEnable = allData.inputEnable;
      if (inputEnable == false) {
        setStatusMessage2("");
        confirmAsync("æƒ…å ±", "ç¾åœ¨ã€ç®¡ç†è€…ã«ã‚ˆã‚Šå…¥åŠ›ãŒç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™ã€‚");
        return;
      }
      studentMailAddress = currentStudentData[STUDENT_DATA.MAIL_ADDR]
      setStudentData("targetStudentName");
      setElementHidden('selectorSection', true);
      setElementHidden('inputSection', false);
      setInputTable(); // ç©ºã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å…ˆã«è¡¨ç¤º

      // å—é¨“ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      //setDialogSpinner(" å¿—æœ›æ ¡ãƒ‡ãƒ¼ã‚¿èª­è¾¼ä¸­ãƒ»ãƒ»ãƒ»");
      //setDialogSpinner(`ã‚ˆã†ã“ãã€${currentStudentData[STUDENT_DATA.NAME]} ã•ã‚“`);

      // å—é¨“ãƒ‡ãƒ¼ã‚¿ã‚’éåŒæœŸã§å–å¾—
      google.script.run
        .withSuccessHandler(examJSON => {
          examDataList = padRowsWithHeader(JSON.parse(examJSON) || []);
          setInputTable(); // ãƒ‡ãƒ¼ã‚¿ã‚’åæ˜ 
          setStatusMessage2("");
          //showProgressDialog(false);
          //console.log('å—é¨“ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãŒå®Œäº†ã—ã¾ã—ãŸ');
        })
        .withFailureHandler(error => {
          console.error(error);
          setStatusMessage2("");
          //showProgressDialog(false);
          confirmAsync("ã‚¨ãƒ©ãƒ¼", "å—é¨“ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>è©³ç´°: " + error.message);
        })
        .getExamDataList();

      getUniversityDataList();
    } else {

      showProgressDialog(false);
      confirmAsync("è­¦å‘Š", "å…¥åŠ›ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>ç®¡ç†è€…ã«å•ã„åˆã‚ã›ã¦ãã ã•ã„ã€‚");
      return;
    }
  }

  function setMyName(name) {
    const myNameDiv = dom.currentUserName;
    myNameDiv.textContent = name;
  }

  //--------------------------------------------------------------------------------
  // æ•™å“¡ãƒšãƒ¼ã‚¸ç”Ÿå¾’é¸æŠ
  //--------------------------------------------------------------------------------
  function showSelector() {
    const classes = Array.from(new Set(allStudentsData.map(arr => arr[STUDENT_DATA.CLASS])));
    classes.sort(); // ã‚¯ãƒ©ã‚¹åã§ã‚½ãƒ¼ãƒˆ
    createClassSelector(classes);
  }

  function createClassSelector(arr) {
    // ã‚¯ãƒ©ã‚¹ä¸€è¦§ãƒªã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹
    const selClassDiv = dom.classSelectionContainer;
    selClassDiv.replaceChildren(); // ã¾ãŸã¯ selClassDiv.innerHTML = '';

    const label = document.createTextNode('ã‚¯ãƒ©ã‚¹ï¼š ');
    selClassDiv.appendChild(label);
    const selectEl = document.createElement('select');
    selectEl.id = 'classSelect';
    dom.classSelect = selectEl;
    selectEl.addEventListener('change', createStudentList);
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'é¸æŠ';
    defaultOption.selected = true;
    defaultOption.disabled = false;
    selectEl.appendChild(defaultOption);
    arr.forEach(className => { // ã‚¯ãƒ©ã‚¹ã®ãƒªã‚¹ãƒˆã‹ã‚‰ <option> è¦ç´ ã‚’ç”Ÿæˆã—ã¦è¿½åŠ 
      const option = document.createElement('option');
      option.value = className;
      option.textContent = className + 'çµ„';
      selectEl.appendChild(option);
    });
    selClassDiv.appendChild(selectEl);
  }

  function createStudentList() { // é¸æŠã•ã‚ŒãŸã‚¯ãƒ©ã‚¹ã®ç”Ÿå¾’ä¸€è¦§ç”Ÿæˆ
    setElementHidden("inputSection", true);
    const selClassId = dom.classSelect;
    const selClass = selClassId.value;
    const students = allStudentsData.filter(row => row[STUDENT_DATA.CLASS] == selClass);
    const selNumDiv = dom.studentNumberSelectionContainer;
    selNumDiv.replaceChildren();

    const label = document.createTextNode('ç•ªå·ï¼šæ°å ');
    selNumDiv.appendChild(label);
    const selectEl = document.createElement('select');
    selectEl.id = 'studentSelectorInput';
    dom.studentSelectorInput = selectEl;
    selectEl.addEventListener('change', handleStudentSelect);
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'é¸æŠ';
    defaultOption.selected = true;
    defaultOption.disabled = false;
    selectEl.appendChild(defaultOption);
    students.forEach(student => {
      const option = document.createElement('option');
      option.value = student[STUDENT_DATA.MAIL_ADDR];
      let strNum = ('0' + student[STUDENT_DATA.NUMBER] + 'ï¼š').slice(-3);
      option.textContent = strNum + student[STUDENT_DATA.NAME];
      selectEl.appendChild(option);
    });
    selNumDiv.appendChild(selectEl);
  }

  async function handleStudentSelect() {
    try {
      if (isItemChanged && !await confirmAsync("ç¢ºèª", "å¤‰æ›´ã‚’ä¿å­˜ã›ãšã«ç§»å‹•ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹")) {
        return;
      }
      const selectEl = dom.studentSelectorInput;
      const mailAddr = selectEl.value;

      if (mailAddr.length == 0) {
        return;
      }

      currentStudentData = allStudentsData.find(row => row[0] == mailAddr)
      studentMailAddress = mailAddr;

      setStudentData("targetStudentName");
      getExamDataList()
    } catch (e) {
      console.error("error in handleStudentSelect", e);
    }
  }

  //--------------------------------------------------------------------------------
  // ãã®ä»–
  //--------------------------------------------------------------------------------
  function setDialogSpinner(text) {
    const idStatusMsg = dom.progressDialogMessageContainer;
    idStatusMsg.replaceChildren();

    if (text.length) {
      const divSpinner = document.createElement("div");
      divSpinner.className = "span-spinner-big"
      idStatusMsg.append(divSpinner)
      const divMessage = document.createElement("div");
      divMessage.textContent = text
      idStatusMsg.append(divMessage)
    }
  }

  function disableScroll(event) {
    event.preventDefault();
  }

  function setInputVisibility(vis) {
    dom.inputTableContainer.style.visibility = vis;
  }


  function showProgressDialog(vis) {
    if (vis) {
      if (!dom.progressDialog.open) dom.progressDialog.showModal();
    } else {
      dom.progressDialog.close(); // å‰Šé™¤ã®ç¢ºèª
    }

  }

  //--------------------------------------------------------------------------------
  // å¤§å­¦ã‚³ãƒ¼ãƒ‰å–å¾—
  //--------------------------------------------------------------------------------
  const universityMap = new Map;

  function getUniversityDataList() {
    const CACHE_KEY = 'universityDataCache';
    const CACHE_TIMESTAMP_KEY = 'universityDataTimestamp';
    const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24æ™‚é–“

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ç¢ºèª
    try {
      const cachedData = localStorage.getItem(CACHE_KEY);
      const cachedTimestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);

      if (cachedData && cachedTimestamp) {
        const age = Date.now() - parseInt(cachedTimestamp);
        if (age < CACHE_DURATION) {
          //console.log('å¤§å­¦ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—ã—ã¾ã—ãŸ');
          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—ã™ã‚‹å ´åˆã‚‚ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è¨­å®š
          isUniversityCodeLoading = true;
          disableSearchButton(true);
          setStatusMessage('å¤§å­¦ã‚³ãƒ¼ãƒ‰å–å¾—ä¸­ï¼ï¼ï¼');
          onUniversityDataReceived(cachedData);
          return;
        } else {
          console.warn('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™');
        }
      }
    } catch (e) {
      console.warn('localStorageã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒä½¿ãˆãªã„å ´åˆã¯é€šå¸¸é€šã‚Šã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—
    }

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã„ã€ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã®å ´åˆã¯ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—
    isUniversityCodeLoading = true;
    disableSearchButton(true);
    setStatusMessage('å¤§å­¦ã‚³ãƒ¼ãƒ‰å–å¾—ä¸­ï¼ï¼ï¼')
    google.script.run
      .withSuccessHandler(str => {
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
        try {
          localStorage.setItem(CACHE_KEY, str);
          localStorage.setItem(CACHE_TIMESTAMP_KEY, Date.now().toString());
          //console.log('å¤§å­¦ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ã—ã¾ã—ãŸ');
        } catch (e) {
          console.warn('localStorageã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
        }
        onUniversityDataReceived(str);
      })
      .withFailureHandler(error => {
        console.error(error);
        showProgressDialog(false); // ãã‚‹ãã‚‹ã‚’æ¶ˆã™
        confirmAsync("ã‚¨ãƒ©ãƒ¼", "å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>æ™‚é–“ã‚’ãŠã„ã¦å†åº¦è©¦ã™ã‹ã€å…ˆç”Ÿã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚<br>è©³ç´°: " + error.message);
      })
      .getUniversityDataList();
  }

  function onUniversityDataReceived(str) {
    universityCodeList = JSON.parse(str) || [];
    universityCodeList.forEach(drow => universityMap.set(String(drow[0]), drow[1]));
    isUniversityCodeLoading = false;
    disableSearchButton(false);
    setStatusMessage('');
  }

  function setStatusMessage(text) {
    const idStatusMsg = dom.statusMessage;
    idStatusMsg.innerHTML = '';

    if (text.length) {
      const spanSpinner = document.createElement("span");
      spanSpinner.className = "span-spinner"
      idStatusMsg.append(spanSpinner)
      idStatusMsg.append(text)
    }
  }

  function setStatusMessage2(text) {
    const idStatusMsg = dom.statusMessage2;
    idStatusMsg.innerHTML = '';

    if (text.length) {
      const spanSpinner = document.createElement("span");
      spanSpinner.className = "span-spinner"
      idStatusMsg.append(spanSpinner)
      idStatusMsg.append(text)
    }
  }

  function disableSearchButton(flag) {
    const buttons = document.querySelectorAll('.search-button');
    buttons.forEach(button => {
      button.disabled = flag;
    });
    const texts = document.querySelectorAll('.university-code');
    texts.forEach(text => {
      text.disabled = flag;
    });
  }

  function setEventListeners() {
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼:jukentableå…¨ä½“ã«ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    const inputTableContainer = dom.inputTableContainer;
    inputTableContainer.addEventListener('click', (event) => {
      const target = event.target;
      if (target.classList.contains('search-button')) {
        const row = target.closest('tr'); // ãƒœã‚¿ãƒ³ãŒæ‰€å±ã™ã‚‹è¡Œã‚’å–å¾—
        const rank = row.querySelector('.rank-cell').textContent;
        searchUniversityCode(rank);
      }
      if (target.classList.contains('clear-button')) {
        const row = target.closest('tr');
        const rank = row.querySelector('.rank-cell').textContent;
        clearRow(rank);
      }
      if (target.classList.contains('proceed-radio')) {
        onProceedRadioClicked(target);
      }
    });
    inputTableContainer.addEventListener('change', (event) => {
      const target = event.target;
      setItemChanged();
      if (target.classList.contains('university-code')) { // å¤§å­¦ã‚³ãƒ¼ãƒ‰ãŒå¤‰æ›´ã•ã‚ŒãŸ
        const row = target.closest('tr');
        const rank = row.querySelector('.rank-cell').textContent;
        setUniversityName('universityCode' + rank);
      }
    });
    // å—é¨“æ ¡ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒœã‚¿ãƒ³
    dom.sendFormButton1.addEventListener("click", sendExamData);
    dom.sendFormButton2.addEventListener("click", sendExamData);
    dom.issueReportButton1.addEventListener("click", requestReport);
    dom.issueReportButton2.addEventListener("click", requestReport);
    //document.getElementById("cancelButton1").addEventListener("click", showSelector);
    //document.getElementById("cancelButton2").addEventListener("click", showSelector);
    // searchtableå…¨ä½“ã«ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    const searchTableDiv = dom.searchTableContainer;

    searchTableDiv.addEventListener('click', (event) => {
      const target = event.target;
      if (target.classList.contains('select-button')) {
        const row = target.closest('tr');
        const dcode = row.dataset.dcode
        setUniversityCode(dcode);
      }
    });
    // æ¤œç´¢ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒœã‚¿ãƒ³
    dom.searchButton.addEventListener("click", () => { displayStart = 0; searchKeyword(); }); // å…ˆé ­ã‹ã‚‰è¡¨ç¤º
    dom.keywordInput.addEventListener("input", () => { displayStart = 0; searchKeyword(); }); // å…ˆé ­ã‹ã‚‰è¡¨ç¤º
    dom.moveLeftButton.addEventListener('click', () => { displayStart -= displayStep; searchKeyword(); }) // å‰ã®ãƒšãƒ¼ã‚¸ã¸
    dom.moveRightButton.addEventListener('click', () => { displayStart += displayStep; searchKeyword(); }); // æ¬¡ã®ãƒšãƒ¼ã‚¸ã¸
    dom.cancelButton.addEventListener("click", cancelSearch);
    dom.searchBackground.addEventListener('click', cancelSearch);
    dom.searchBody.addEventListener('click', (event) => { event.stopPropagation(); });

    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã®å–å¾—
    window.addEventListener('scroll', () => { currentY = window.scrollY; currentX = window.scrollX; });
  }

  //--------------------------------------------------------------------------------
  // å…¥åŠ›ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«é–¢é€£
  //--------------------------------------------------------------------------------
  let selectedProceedRadioId = ""; // é¸æŠã•ã‚Œã¦ã„ã‚‹é€²å­¦å…ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ID

  function setStudentData(id) {
    let str = '';
    str += (currentStudentData?.[STUDENT_DATA.GRADE] || "") + 'å¹´ ';
    str += (currentStudentData?.[STUDENT_DATA.CLASS] || "") + 'çµ„ ';
    str += (currentStudentData?.[STUDENT_DATA.NUMBER] || "") + 'ç•ª æ°å ';
    str += (currentStudentData?.[STUDENT_DATA.NAME] || "");
    if (dom[id]) dom[id].textContent = str;
  }


  function disableReportButton(flag) {
    dom.issueReportButton1.disabled = flag;
    dom.issueReportButton2.disabled = flag;

  }
  function disableSendButton(flag) {
    dom.sendFormButton1.disabled = flag;
    dom.sendFormButton2.disabled = flag;
  }

  function setSendMessage(text) {
    dom.sendFormButton1Message.textContent = text;
    dom.sendFormButton2Message.textContent = text;
  }


  // å…¥åŠ›ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ
  function setInputTable() {
    // ãƒ†ãƒ¼ãƒ–ãƒ«æœ¬ä½“
    const template = dom.examRowTemplate;

    const tableBody = document.createElement('tbody');

    for (let i = 0; i < examMaxInputCount; i++) {
      const rowClone = template.content.cloneNode(true);
      const hasData = i < examDataList.length;
      const jukenItem = hasData ? examDataList[i] : null; // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°å–å¾—ã€ãªã‘ã‚Œã°null
      const dcode = rowClone.querySelector('.university-code');
      const dname = rowClone.querySelector('.university-name');
      const keitaiCell = rowClone.querySelector('.exam-type-select-cell');
      const gouhiCell = rowClone.querySelector('.result-select-cell');
      const shingakuRadio = rowClone.querySelector('.proceed-radio');
      const searchBtn = rowClone.querySelector('.search-button');
      const clearBtn = rowClone.querySelector('.clear-button');
      rowClone.querySelector('.rank-cell').textContent = i + 1;
      dcode.id = 'universityCode' + (i + 1);
      dname.id = 'universityName' + (i + 1);
      shingakuRadio.id = 'proceed' + (i + 1);
      searchBtn.id = 'searchButton' + (i + 1);
      clearBtn.id = 'deleteButton' + (i + 1);

      dom['universityCode' + (i + 1)] = dcode;
      dom['universityName' + (i + 1)] = dname;
      dom['proceed' + (i + 1)] = shingakuRadio;
      dom['searchButton' + (i + 1)] = searchBtn;
      dom['deleteButton' + (i + 1)] = clearBtn;

      if (hasData) {
        dcode.value = jukenItem[EXAM_DATA.DAIGAKU_CODE];
        dname.textContent = jukenItem[EXAM_DATA.DAIGAKU_NAME];
        keitaiCell.appendChild(createExamTypeSelect(i, jukenItem[EXAM_DATA.KEITAI]));
        gouhiCell.appendChild(createResultSelect(i, jukenItem[EXAM_DATA.GOUHI]));
        if (String(jukenItem[EXAM_DATA.SHINGAKU]).toUpperCase() === "TRUE") {
          shingakuRadio.checked = true;
          selectedProceedRadioId = shingakuRadio.id;
        }
      } else {
        keitaiCell.appendChild(createExamTypeSelect(i, ""));
        gouhiCell.appendChild(createResultSelect(i, ""));
      }
      tableBody.appendChild(rowClone);
    }
    const tr = document.createElement("tr");
    tr.classList.add("thead-row");
    tr.classList.add("table-header-row");
    // ãƒ˜ãƒƒãƒ€ãƒ¼ã®é…åˆ—
    const headers = [
      "No",
      "å¤§å­¦ã‚³ãƒ¼ãƒ‰",
      "å­¦æ ¡åãƒ»å­¦éƒ¨ãƒ»å­¦ç§‘ãƒ»æ–¹å¼ãƒ»æ—¥ç¨‹",
      "è©¦é¨“å½¢æ…‹",
      "åˆå¦",
      "é€²å­¦",
      "å‰Šé™¤"
    ];
    headers.forEach((text, i) => {
      const th = document.createElement("th");
      th.textContent = text;
      tr.appendChild(th);
    });
    const tHead = document.createElement('thead');
    tHead.appendChild(tr);
    const table = document.createElement('table');
    table.classList.add('input-table');
    table.appendChild(tHead);
    table.appendChild(tableBody);
    const inputTableContainer = dom.inputTableContainer;
    inputTableContainer.replaceChildren();
    inputTableContainer.appendChild(table);

    // å¤§å­¦ãƒ‡ãƒ¼ã‚¿ãŒæ—¢ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹
    if (isUniversityCodeLoading == false && universityCodeList.length > 0) {
      disableSearchButton(false);
    }
  }


  function checkDuplicate(inputId) {
    const input = dom[inputId];
    for (let i = 0; i < examMaxInputCount; i++) {
      let id = 'universityCode' + (i + 1);
      const ddata = dom[id];

      if (ddata != input) {
        if (input.value.trim() == ddata.value.trim()) {
          return i + 1;
        }
      }
    }
    return 0;
  }

  function setUniversityName(dn) {
    const dcodeSpan = dom[dn];
    const dcode = dcodeSpan.value.trim();
    const dnameSpan = dom[dn.replace('universityCode', 'universityName')];


    if (dcode.length == 0) {
      dnameSpan.innerHTML = '';
      return;
    }
    const row = checkDuplicate(dn);
    if (row > 0) {
      dnameSpan.innerHTML = `<span style="color:red;">${dcode}ã¯å¿—æœ›æ ¡${row}ã¨é‡è¤‡ã—ã¦ã„ã¾ã™</span>`;
      dcodeSpan.value = ''; // ä¸æ­£ãªã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªã‚¢              
      return;
    }
    const dname = universityMap.get(dcode);
    if (dname) {
      dnameSpan.textContent = dname;
    } else {
      dnameSpan.innerHTML = `<span style="color:red;">ã‚³ãƒ¼ãƒ‰ã«èª¤ã‚ŠãŒã‚ã‚Šã¾ã™</span>`;
      dcodeSpan.value = ''; // ä¸æ­£ãªã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªã‚¢
    }
  }

  function createExamTypeSelect(i, selectedValue) {
    const select = document.createElement('select');
    select.name = 'examType' + (i + 1);
    select.id = 'examType' + (i + 1);
    dom['examType' + (i + 1)] = select;


    examTypeOptions.forEach(optionValue => {
      const option = document.createElement('option');
      option.value = optionValue;
      option.textContent = optionValue;
      if (optionValue === selectedValue) {
        option.selected = true;
      }
      select.appendChild(option);
    });
    return select;
  }

  function createResultSelect(i, selectedValue) {
    const select = document.createElement('select');
    select.name = 'result' + (i + 1);
    select.id = 'result' + (i + 1);
    dom['result' + (i + 1)] = select;


    resultOptions.forEach(optionValue => {
      const option = document.createElement('option');
      option.value = optionValue;
      option.textContent = optionValue;
      if (optionValue === selectedValue) {
        option.selected = true;
      }
      select.appendChild(option);
    });
    return select;
  }

  async function clearRow(i) {
    let result = await confirmAsync("å‰Šé™¤/å¾©å…ƒ", "å¿—æœ›æ ¡ " + i + " ã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ");
    if (result) {
      const idc = dom["universityCode" + i];
      const idb = dom["searchButton" + i];
      const idn = dom["universityName" + i];
      const idk = dom["examType" + i];
      const idr = dom["result" + i];
      const ids = dom["proceed" + i];
      const arrid = [idc, idb, idn, idk, idr, ids];
      const idd = dom["deleteButton" + i];

      if (idk.disabled == false) { // idc, idnã¯å¤§å­¦ã‚³ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿å‰ã¯ disable
        arrid.forEach(id => {
          id.disabled = true;
          id.style.textDecoration = "line-through";
          id.style.opacity = 0.6;
        });
        idd.textContent = "æˆ»ã™";
      } else {
        arrid.forEach(id => {
          id.disabled = false;
          id.style.textDecoration = "none";
          id.style.opacity = 1;
          //id.style.color = "#000";
          //id.style.backgroundColor = "#FFF";
        });
        idd.textContent = "å‰Šé™¤";
      }
      setItemChanged();
    }
  }

  function onProceedRadioClicked(radioItem) {
    if (radioItem.id == selectedProceedRadioId) {
      radioItem.checked = false; // é¸æŠã‚’è§£é™¤
      selectedProceedRadioId = ""; // é¸æŠçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
      setItemChanged();
    } else {
      selectedProceedRadioId = radioItem.id;
    }
  }

  function setItemChanged() {
    if (!isItemChanged) {
      isItemChanged = true;
      disableSendButton(false);
      disableReportButton(true);
      setSendMessage('å¤‰æ›´æœ‰â†’')
      window.onbeforeunload = function (e) {
        e.returnValue = "å¤‰æ›´ã‚’ä¿å­˜ã›ãšã«ç§»å‹•ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ";
      }
    }
  }
  //--------------------------------------------------------------------------------
  // å¤§å­¦ã‚³ãƒ¼ãƒ‰ãƒ†ãƒ¼ãƒ–ãƒ«é–¢é€£
  //--------------------------------------------------------------------------------
  let currentRow = 0; // å¤§å­¦æ¤œç´¢ã‚’å‘¼ã³å‡ºã—ãŸè¡Œ
  let currentY = 0; //ç¾åœ¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®
  let currentX = 0;
  let inputPosY = 0; // inputãƒ†ãƒ¼ãƒ–ãƒ«ç¾åœ¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®
  let inputPosX = 0;
  let searchPosY = 0; // inputãƒ†ãƒ¼ãƒ–ãƒ«ç¾åœ¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®
  let searchPosX = 0;

  function toggleSearchDisplay(flag) {
    if (flag) {
      inputPosY = currentY;
      inputPosX = currentX;
      window.scrollTo(searchPosX, searchPosY);
      setElementHidden('searchBackground', false);
      setElementHidden('inputBackground', true);
      //document.getElementById("searchBackground").style.display = "block";
      //document.getElementById("inputBackground").style.display = "none";
    } else {
      searchPosY = currentY;
      searchPosX = currentX;
      window.scrollTo(inputPosX, inputPosY);
      setElementHidden('searchBackground', true);
      setElementHidden('inputBackground', false);
      //document.getElementById("searchBackground").style.display = "none";
      //document.getElementById("inputBackground").style.display = "block";
    }
  }

  function searchUniversityCode(row) {
    currentRow = row;
    toggleSearchDisplay(true);
    displayStart = 0;
    searchKeyword();
  }

  // æœ€å¾Œã®å…¥åŠ›ã‹ã‚‰æŒ‡å®šæ™‚é–“å¾Œã«å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã€Œãƒ‡ãƒã‚¦ãƒ³ã‚¹ã€é–¢æ•°
  let debounceTimer;

  function debounce(func, delay) {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(func, delay);
  }

  let displayStart = 0;
  const displayStep = 50;

  // ãƒ•ã‚£ãƒ«ã‚¿ã‚’ã‹ã‘ãŸãƒ‡ãƒ¼ã‚¿ã‚’éƒ½åº¦ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã™ã‚‹
  function getFilteredUniversity(searchWord) {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(str => resolve(JSON.parse(str)))
        .withFailureHandler(reject)
        .getFilteredUniversityDataList(searchWord, displayStart, displayStep);
    });
  }

  function searchKeyword() {
    // ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ã‚’æŒŸã‚€
    debounce(async () => {
      const keywordInput = dom.keywordInput.value;
      const dcTotal = dom.displayCountTotal;
      const dcRange = dom.displayCountRange;
      const resultsContainer = dom.searchTableContainer;
      resultsContainer.replaceChildren(); // å‰å›ã®æ¤œç´¢çµæœã‚’ã‚¯ãƒª
      // ----- å¤§å­¦ãƒ‡ãƒ¼ã‚¿å…¨ä»¶äº‹å‰ãƒ­ãƒ¼ãƒ‰
      const keywords = keywordInput.replace(/ã€€/g, ' ').split(' ').filter(kw => kw); // ç©ºã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’é™¤å¤–
      const filteredData = universityCodeList.filter(row =>
        keywords.every(kw => (row[1] || "").includes(kw) || String(row[0] || "").includes(kw))
      );
      const limitedData = filteredData.slice(displayStart, displayStart + displayStep);
      const total = filteredData.length;
      // ----- å¤§å­¦ãƒ‡ãƒ¼ã‚¿éƒ½åº¦ã‚²ãƒƒãƒˆ
      /*
      setDialogSpinner('æ¤œç´¢ä¸­ï¼ï¼ï¼')
      showProgressDialog(true);
      const objResult = await getFilteredUniversity(keywordInput);
      showProgressDialog(false);
      const limitedData = objResult.data;
      const total = objResult.total;
      */
      // -----
      const moveLeft = dom.moveLeftButton;
      const moveRight = dom.moveRightButton;

      moveLeft.disabled = (displayStart <= 0);
      moveRight.disabled = (displayStart + displayStep >= total);
      const dend = total > displayStart + displayStep ? displayStart + displayStep : total
      dcRange.textContent = ` ${displayStart + 1} ï½ ${dend} `;
      dcTotal.textContent = ` ï¼ ${total} ä»¶`;
      // 2. æ¤œç´¢çµæœãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
      const table = document.createElement('table');
      table.classList.add('search-table');
      // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä½œæˆ
      const tableHead = table.createTHead();
      const headerRow = tableHead.insertRow();
      headerRow.classList.add('table-header-row');
      const headers = ['å­¦æ ¡åãƒ»å­¦éƒ¨ãƒ»å­¦ç§‘ãƒ»å…¥è©¦æ–¹å¼ãƒ»æ—¥ç¨‹', 'å¤§å­¦ã‚³ãƒ¼ãƒ‰', 'é¸æŠ'];
      headers.forEach(text => {
        const th = document.createElement('th');
        th.textContent = text;
        headerRow.appendChild(th);
      });
      const tableBody = table.createTBody();
      tableBody.id = "searchTable";
      limitedData.forEach(dataRow => {
        const code = dataRow[0];
        const name = dataRow[1];
        const tr = tableBody.insertRow();
        tr.classList.add("result-row");
        tr.dataset.dcode = dataRow[0];
        tr.dataset.dname = dataRow[1];
        // å­¦æ ¡åã‚»ãƒ«
        const nameCell = tr.insertCell();
        nameCell.textContent = name;
        nameCell.dataset.label = "å­¦æ ¡åç­‰ï¼š"; // ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œã®ãƒ©ãƒ™ãƒ«
        // å¤§å­¦ã‚³ãƒ¼ãƒ‰ã‚»ãƒ«
        const codeCell = tr.insertCell();
        codeCell.dataset.label = "ã‚³ãƒ¼ãƒ‰ï¼š";
        codeCell.classList.add("text-center");
        const codeInput = document.createElement('input');
        codeInput.type = 'text';
        codeInput.value = code;
        codeInput.readOnly = true;
        codeInput.size = 10;
        codeCell.appendChild(codeInput);
        // é¸æŠãƒœã‚¿ãƒ³ã‚»ãƒ«
        const buttonCell = tr.insertCell();
        buttonCell.classList.add("text-center");
        const selectButton = document.createElement('button');
        selectButton.textContent = 'é¸æŠ';
        selectButton.classList.add("select-button");
        buttonCell.appendChild(selectButton);
      });
      resultsContainer.appendChild(table);
    }, 1000);
  }

  function setUniversityCode(dcode) {
    const dcodeSpan = dom['universityCode' + currentRow];

    dcodeSpan.value = String(dcode);
    setUniversityName('universityCode' + currentRow);
    setItemChanged();
    cancelSearch(); // æ¤œç´¢ç”»é¢ã‚’é–‰ã˜ã‚‹
  }

  function cancelSearch() {
    toggleSearchDisplay(false);
  }

  //--------------------------------------------------------------------------------
  // ãƒ‡ãƒ¼ã‚¿é€ä¿¡
  //--------------------------------------------------------------------------------
  let isReloadRequired;

  async function sendExamData() {
    if (!isItemChanged) return;
    window.onbeforeunload = null;
    let result = await confirmAsync("ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜", "ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ");
    if (!result) return;
    setDialogSpinner(" å¿—æœ›æ ¡ãƒ‡ãƒ¼ã‚¿é€ä¿¡ä¸­ãƒ»ãƒ»ãƒ»")
    showProgressDialog(true);
    disableSendButton(true);
    disableReportButton(false);
    examDataList.length = 0;
    isReloadRequired = false;
    for (let i = 0; i < examMaxInputCount; i++) {
      const dcode = dom['universityCode' + (i + 1)].value;
      const isDelete = dom['examType' + (i + 1)].disabled;
      if (isDelete) isReloadRequired = true;
      if (dcode || dcode.length > 0) {
        let rowData = [];
        rowData[EXAM_DATA.TIME_STAMP] = '';
        rowData[EXAM_DATA.MAIL_ADDR] = currentStudentData[0];
        rowData[EXAM_DATA.DEL_FLAG] = isDelete;
        rowData[EXAM_DATA.DAIGAKU_CODE] = String(dcode);
        rowData[EXAM_DATA.DAIGAKU_NAME] = universityMap.get(String(dcode));
        rowData[EXAM_DATA.GOUHI] = dom['result' + (i + 1)].value;
        rowData[EXAM_DATA.KEITAI] = dom['examType' + (i + 1)].value;
        rowData[EXAM_DATA.SHINGAKU] = dom['proceed' + (i + 1)].checked;
        examDataList.push(rowData);
      } else {
        dom['universityName' + (i + 1)].textContent = '';
      }

    }
    const strJuken = JSON.stringify(examDataList);
    google.script.run
      .withSuccessHandler(onExamDataSent)
      .withFailureHandler(error => {
        console.error(error);
        showProgressDialog(false); // ãã‚‹ãã‚‹ã‚’æ¶ˆã™
        confirmAsync("ã‚¨ãƒ©ãƒ¼", "å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>æ™‚é–“ã‚’ãŠã„ã¦å†åº¦è©¦ã™ã‹ã€å…ˆç”Ÿã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚<br>è©³ç´°: " + error.message);
      })
      .saveExamDataList(strJuken, studentMailAddress);
  }

  function onExamDataSent(strJSON) {
    setSendMessage('');
    isItemChanged = false;
    disableSendButton(true);
    showProgressDialog(false);

    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã•ã‚ŒãŸæœ€æ–°ãƒ‡ãƒ¼ã‚¿ã§æ›´æ–°
    if (strJSON) {
      examDataList = padRowsWithHeader(JSON.parse(strJSON));
      setInputTable();
    }
  }

  function getExamDataList() {
    setDialogSpinner(" å¿—æœ›æ ¡ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­ãƒ»ãƒ»ãƒ»");
    showProgressDialog(true);
    setSendMessage('');
    isItemChanged = false;
    google.script.run
      .withSuccessHandler(onExamDataReceived)
      .withFailureHandler(error => {
        console.error(error);
        showProgressDialog(false); // ãã‚‹ãã‚‹ã‚’æ¶ˆã™
        confirmAsync("ã‚¨ãƒ©ãƒ¼", "å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>æ™‚é–“ã‚’ãŠã„ã¦å†åº¦è©¦ã™ã‹ã€å…ˆç”Ÿã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚<br>è©³ç´°: " + error.message);
      })
      .getExamDataList(studentMailAddress)
  }

  function onExamDataReceived(strJSON) {
    isDeleted = false;
    examDataList = padRowsWithHeader(JSON.parse(strJSON));
    showProgressDialog(false);
    disableReportButton(false);
    //setElementHidden("selectorSection", true);
    setElementHidden("inputSection", false);
    setInputTable();
    //setInputVisibility("visible");
    if (isUniversityCodeLoading == false) disableSearchButton(false);
  }

  //--------------------------------------------------------------------------------
  // èª¿æŸ»æ›¸ç™ºè¡Œé¡˜
  //--------------------------------------------------------------------------------
  async function requestReport() {
    let result = await confirmAsync("ãƒ¡ãƒ¼ãƒ«é€ä¿¡", myMailAddress + "<br>ã«ç™ºè¡Œé¡˜ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ");
    if (!result) return;
    setDialogSpinner(" äº¤ä»˜é¡˜PDFä½œæˆä¸­ãƒ»ãƒ»ãƒ»");
    showProgressDialog(true);
    google.script.run
      .withSuccessHandler(onReportCreated)
      .withFailureHandler(error => {
        console.error(error);
        showProgressDialog(false); // ãã‚‹ãã‚‹ã‚’æ¶ˆã™
        confirmAsync("ã‚¨ãƒ©ãƒ¼", "å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>æ™‚é–“ã‚’ãŠã„ã¦å†åº¦è©¦ã™ã‹ã€å…ˆç”Ÿã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚<br>è©³ç´°: " + error.message);
      })
      .sendPdf(studentMailAddress);
  }

  function onReportCreated() {
    showProgressDialog(false);
  }

  //--------------------------------------------------------------------------------
  // ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
  //--------------------------------------------------------------------------------
  window.onload = pageLoaded;

  //--------------------------------------------------------------------------------
  // ãƒ‡ãƒ¼ã‚¿è£œæ­£ãƒ˜ãƒ«ãƒ‘ãƒ¼ (APIã®è¡Œæœ«æ¬ æå¯¾ç­–ï¼šãƒ˜ãƒƒãƒ€ãƒ¼åŸºæº–)
  //--------------------------------------------------------------------------------
  function padRowsWithHeader(rows) {
    if (!Array.isArray(rows) || rows.length === 0) return [];

    // 1è¡Œç›®ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã—ã¦æ‰±ã„ã€ãã®é•·ã•ã‚’åŸºæº–ã«ã™ã‚‹
    const header = rows[0];
    const headerLength = header.length;

    // 2è¡Œç›®ä»¥é™ã®ãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ã‚’å–å¾—
    const dataRows = rows.slice(1);

    // ãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ã«å¯¾ã—ã¦ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’é©ç”¨
    return dataRows.map(row => {
      if (!Array.isArray(row)) return row;
      while (row.length < headerLength) {
        row.push("");
      }
      return row;
    });
  }
</script>