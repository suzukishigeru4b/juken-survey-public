# 受験校調査システム (GAS Web App)

Google Apps Script (GAS) と Google スプレッドシートを連携させた、高校生向けの受験校調査・管理システムです。
生徒はスマートフォンやPCから受験予定校や合否結果を登録し、教員はリアルタイムで状況を把握できます。また、調査書発行願のPDF自動生成やメール送信機能を備えています。

## 📋 機能一覧

### 生徒向け機能
* **受験校登録・管理**: 志望校、受験方式、合否結果、進学先等の登録・編集。
* **大学検索**: Benesseのマスタデータに基づく大学・学部・学科の検索（インクリメンタルサーチ・デバウンス対応）。
* **調査書交付願の発行**: 登録データに基づき、PDF形式の交付願を自動生成し、メールで送信。
* **レスポンシブデザイン**: スマートフォンでの操作に最適化されたカード型UIと、PC向けのテーブル表示の自動切り替え。

### 教員・管理者向け機能
* **生徒データ閲覧**: クラス・出席番号による生徒の絞り込みとデータ参照。
* **代理入力**: 教員権限による生徒データの代理修正（ログ記録あり）。
* **データ管理**:
    * Benesse大学入試データのインポート機能。
    * 校内DB用データの整形・出力機能。
* **設定管理**: スプレッドシート上でのシステム稼働設定（入力期間の制限、メール文面など）。

## 🛠 システム構成

### ファイル構成
| ファイル名 | 役割 |
| :--- | :--- |
| `main.gs` | サーバーサイドロジック（DB操作、PDF生成、メール送信、API、キャッシュ制御） |
| `index.html` | WebアプリのHTML骨格 |
| `css.html` | スタイルシート（CSS Grid/Flexboxによるレスポンシブ対応） |
| `script.html` | クライアントサイドロジック（Vanilla JSによるDOM操作、非同期通信） |

### データベース（スプレッドシート）
以下のシート名で運用されます（`main.gs` 内の `SHEET_NAMES` 定数で定義）。

1.  **学籍データ**: 生徒の基本情報（メールアドレス、氏名、クラス等）。
2.  **職員データ**: 教員のメールアドレスリスト（権限管理用）。
3.  **受験校DB**: 生徒が入力した受験データの保存先。
4.  **大学データ**: 大学コード、大学名、日程などのマスタデータ。
5.  **設定**: システムのタイトル、入力上限数、稼働フラグ、メール文面など。
6.  **調査書交付願**: PDF生成用のテンプレートシート。
7.  **その他マスタ**: `試験形態`, `合否選択肢`, `受験形態選択肢` など。

## 🚀 セットアップ手順

### 1. スプレッドシートの準備
Googleスプレッドシートを新規作成し、上記の「データベース」セクションにある名前のシートを作成してください。各シートのヘッダー行（1行目）を定義に合わせて作成してください。

### 2. スクリプトの配置
1.  スプレッドシートのメニューから「拡張機能」>「Apps Script」を開きます。
2.  `main.gs`, `index.html`, `css.html`, `script.html` の4つのファイルを作成し、ソースコードを貼り付けます。

### 3. トリガーの設定（重要）
キャッシュの自動更新（デバウンス機能付き）を行うため、以下のトリガーを手動で設定する必要があります。

1.  Apps Scriptエディタ左側の「トリガー（時計アイコン）」をクリック。
2.  「トリガーを追加」ボタンをクリック。
3.  以下の設定で保存します。
    * **実行する関数**: `onChange`
    * **実行するデプロイ**: `Head`
    * **イベントのソース**: `スプレッドシートから`
    * **イベントの種類**: `変更時` (**※注意: 「編集時」ではありません**)

### 4. デプロイ
1.  画面右上の「デプロイ」>「新しいデプロイ」を選択。
2.  **種類の選択**: 「ウェブアプリ」。
3.  **説明**: 任意のバージョン名（例: `v1.0.0`）。
4.  **次のユーザーとして実行**: `自分`（作成者）。
5.  **アクセスできるユーザー**: `Googleアカウントを持つ全員` または `ドメイン内の全員`。
6.  発行されたURLを生徒・教員に配布します。

## 🔒 技術的特徴・セキュリティ

### 堅牢なデータ整合性とセキュリティ
* **排他制御**: `LockService` を使用し、同時アクセス時のデータ上書き（レースコンディション）を防止。
* **サーバーサイドバリデーション**:
    * クライアント側だけでなくサーバー側でも入力値の整合性をチェック。
    * **なりすまし防止**: `Session.getActiveUser()` と送信データを照合し、本人または教員以外の書き込みをブロック。
    * **不正データ排除**: 選択肢にない値や、制限を超えたデータ量をサーバー側で拒否。

### パフォーマンス最適化
* **高度なキャッシュ戦略**:
    * 頻繁にアクセスされるマスタデータ（大学データ等）は `CacheService` に保存。
    * **チャンク分割**: GASのキャッシュサイズ制限（100KB）を回避するため、データを分割して保存・復元するロジックを実装。
    * **デバウンス更新**: スプレッドシート編集時、連続した変更に対して3秒間のデバウンス処理を行い、