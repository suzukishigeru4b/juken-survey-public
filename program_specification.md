# 受験校調査システム プログラム仕様書

## 1. システム概要
本システムは、Google Apps Script (GAS) をプラットフォームとした Webアプリケーションである。
生徒が自身のスマートフォンやPCを用いて「受験校」「試験形態」「合否結果」を登録し、教員がそのデータを管理・閲覧することを目的とする。また、調査書交付願（PDF）の自動生成およびメール送信機能を有する。

### 1.1 動作環境
* **プラットフォーム**: Google Apps Script (V8 Runtime)
* **データベース**: Google スプレッドシート
* **クライアント**: モダンブラウザ (Chrome, Safari, Edge 等) ※ES6対応必須

---

## 2. ファイル構成
プロジェクトは以下の4ファイルで構成される。

| ファイル名 | 分類 | 役割 |
| :--- | :--- | :--- |
| **`main.gs`** | Server | バックエンドロジック、DB操作、API、キャッシュ制御、トリガー処理 |
| **`index.html`** | HTML | アプリケーションの基本構造、DOM要素 |
| **`css.html`** | CSS | スタイル定義、レスポンシブデザイン制御 (Grid/Flexbox) |
| **`script.html`** | Client JS | フロントエンドロジック、DOM操作、非同期通信、イベントハンドリング |

---

## 3. データベース設計 (スプレッドシート構造)

各シートは `main.gs` 内の定数 `SHEET_NAMES` で定義される。

### 3.1 主要シート定義

#### (1) 受験校DB (`SHEET_NAMES.JUKEN_DB`)
生徒が入力した受験データの実体。
| 列Index | 項目名 | データ型 | 備考 |
| :--- | :--- | :--- | :--- |
| 0 | タイムスタンプ | Date string | 最終更新日時 |
| 1 | メールアドレス | String | 生徒IDとして使用 (PK) |
| 2 | 削除フラグ | Boolean | 論理削除用 (true=削除) |
| 3 | 大学コード | String | Benesseコード等 |
| 4 | 大学名 | String | キャッシュ表示用 |
| 5 | 合否 | String | 選択肢より |
| 6 | 試験形態 | String | 選択肢より |
| 7 | 進学 | Boolean | 進学先フラグ |

#### (2) 学籍データ (`SHEET_NAMES.STUDENTS`)
| 列Index | 項目名 | 備考 |
| :--- | :--- | :--- |
| 0 | メールアドレス | キー項目 |
| 1 | 学年 | |
| 2 | クラス | |
| 3 | 出席番号 | |
| 4 | 氏名 | |

#### (3) 大学データ (`SHEET_NAMES.DAIGAKU`)
Benesseデータ等のマスタ。
| 列 | 項目名 | 備考 |
| :--- | :--- | :--- |
| A | 大学コード | 検索キー |
| B | 大学名・学部・学科 | 表示用名称 |
| C~H | 日程データ | Web締切、入試日、発表日等 |

### 3.2 その他のシート
* **職員データ**: 教員権限を持つメールアドレスリスト。
* **設定**: システムタイトル、入力上限数、稼働フラグ、メールテンプレート。
* **調査書交付願**: PDF出力用の帳票テンプレート。
* **各種マスタ**: `試験形態`, `合否選択肢`, `受験形態選択肢`。

---

## 4. 機能仕様 (サーバーサイド: `main.gs`)

### 4.1 データ取得・キャッシュ戦略
* **`getInitialData()`**:
    * ユーザーのメールアドレスに基づき「生徒」か「教員」かを判定し、初期表示に必要なマスタデータと個人データをJSONで返す。
    * **キャッシュ制御**:
        * `CacheService` を利用し、100KBを超えるデータは `putCache` 関数にて自動的にチャンク分割（分割保存）を行う。
        * `getSheetData` はまずキャッシュを確認し、存在しなければスプレッドシートから読み込む。

### 4.2 データ保存・整合性担保
* **`saveExamDataList(strJuken, mailAddr)`**:
    * **排他制御**: `LockService` を使用し、最大30秒間のロックを取得して同時書き込みを防ぐ。
    * **権限チェック**: `isValidUser` 関数により、実行者が「本人」または「教員リストに含まれるユーザー」であることを検証する。なりすましを防止。
    * **バリデーション**: `validateInputData` 関数により、件数超過、不正な選択肢、データ型をチェックする。
    * **強制上書き**: クライアントから送信されたデータのメールアドレス部は無視し、引数の認証済みアドレスで強制的に上書きして保存する。

### 4.3 PDF生成・メール送信
* **`sendPdf(mailAddr)`**:
    * 一時的なスプレッドシートを作成し、テンプレートシートをコピー。
    * 対象生徒のデータと受験校データをセルに埋め込む（置換処理）。
    * PDFとしてエクスポートし、`GmailApp` で本人宛に添付送信する。
    * 処理完了後（またはエラー時）、`finally` ブロックにて一時ファイルを確実に削除（ゴミ箱移動）する。

### 4.4 トリガー処理
* **`onEdit(e)` / `onChange(e)`**:
    * スプレッドシートの変更を検知し、該当シートのキャッシュをクリアする。
    * **デバウンス処理**: `runDebouncedCacheClear` により、連続した変更があった場合でも、最後の操作から3秒後に一度だけキャッシュクリアを実行する。(`PropertiesService`を利用した排他制御)

---

## 5. 機能仕様 (クライアントサイド: `script.html`)

### 5.1 UI制御
* **レスポンシブ対応**:
    * `css.html` のメディアクエリにより、PC（テーブル表示）、タブレット（2段グリッド）、スマホ（カード型スタック表示）にレイアウトを切り替える。
* **非同期ダイアログ**:
    * `<dialog>` 要素と `Promise` を組み合わせた `confirmAsync` 関数により、ネイティブライクかつ非同期な確認画面を提供する。

### 5.2 大学検索機能
* **インクリメンタルサーチ**:
    * 入力キーワードに対し、`debounce` 関数（遅延実行）を用いて検索処理を行うことで、サーバー負荷を軽減する。
* **ページネーション**:
    * 検索結果は50件ごとに分割表示し、DOM描画負荷を抑える。

### 5.3 エラーハンドリング
* `google.script.run` の `withFailureHandler` を全ての呼び出しに実装。
* サーバー側で発生したエラー（バリデーションエラー含む）をキャッチし、ユーザーに分かりやすいメッセージでアラート表示する。

---

## 6. セキュリティ設計

| 項目 | 対策内容 |
| :--- | :--- |
| **なりすまし防止** | `Session.getActiveUser()` で実行者を取得し、操作対象データとの整合性をサーバー側で検証。 |
| **権限昇格防止** | 教員データシートに登録されたユーザーのみが、他者のデータを操作可能。 |
| **不正データ注入** | サーバー側での厳密なバリデーション（ホワイトリスト方式の選択肢チェック）。 |
| **同時実行制御** | `LockService` によるクリティカルセクションの保護。 |
| **データ保護** | 削除操作は「論理削除（フラグ立て）」とし、物理削除は管理者メニューからのみ実行可能。 |

---

## 7. 導入・設定手順

1.  **トリガー設定**:
    * キャッシュ自動更新のため、Apps Script エディタにて以下のトリガーを手動設定すること。
        * 関数: `onChange`
        * イベントの種類: **変更時**
2.  **マスタデータ準備**:
    * Benesse形式のCSVデータがある場合、「校内DB用」メニューからインポートを実行する。
3.  **初期設定**:
    * 「設定」シートにて、システムのタイトル、最大登録件数、入力許可フラグ（`TRUE`/`FALSE`）を設定する。

---

## 8. 制限事項
* **キャッシュ容量**: GASの `CacheService` の制限（キーあたり100KB）に対し、チャンク分割で対応しているが、極端に巨大なデータ（数MBクラス）のキャッシュは推奨しない。
* **PDF生成時間**: PDF生成には数秒〜十数秒かかる場合があるため、クライアント側で「処理中」ダイアログを表示して待機させる仕様としている。