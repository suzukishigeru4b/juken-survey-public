# バージョン変更履歴 (VERSION_CHANGES.md)

## Ver 2.3.0 (2025年12月30日)

### 主な変更点

#### 1. データ取得の一貫性向上（startRowパラメータの廃止）
- **シート取得の統一**: すべてのシートデータを1行目から取得するように変更し、`startRow`パラメータを完全に削除しました。
- **キャッシュキーの簡素化**: キャッシュキーを`sheetName_startRow`から`sheetName`のみに変更し、管理が容易になりました。
- **サーバー側でのデータ処理**: 2行目以降のデータが必要な場合は、サーバー側で`slice(1)`を使用してヘッダー行を削除してからクライアントに送信します。
- **影響範囲**: 13個の関数を更新し、コードの一貫性と保守性が向上しました。

#### 2. キャッシュの自動更新機能の強化
- **編集時トリガー**: `onEdit`トリガーを実装し、対象シート（設定、選択肢マスタ、学籍・職員データ）が編集された際に自動でキャッシュを更新します。
- **変更時トリガー**: `onChange`トリガーでシート構造変更時にもキャッシュを更新します。
- **定期更新**: 1時間ごとに全キャッシュを自動更新するタイムベーストリガーを追加しました。
- **トリガー設定機能**: 新しく`setupTriggers()`関数を実装し、スプレッドシートメニューから簡単にトリガーを設定できるようになりました。

#### 3. スプレッドシートメニューの改善
- **メニュー名変更**: 「校内DB用」から「管理者メニュー」に変更し、役割を明確化しました。
- **新機能追加**:
  - **全キャッシュ更新**: `warmUpAllCache()`を手動で実行できます。
  - **キャッシュ更新トリガー設定**: `setupTriggers()`でトリガーを自動設定できます。
- **メニュー構成**: セパレータを追加して、データ管理機能とキャッシュ管理機能を視覚的に分離しました。

#### 4. 大学データの圧縮送信（計画中）
- **gzip圧縮**: 大学コードデータをgzip圧縮してクライアントに送信することで、通信量を削減します。
- **圧縮状態で保存**: クライアント側では圧縮したままlocalStorageに保存し、使用時に展開します。
- **パフォーマンス向上**: 大規模な大学データベースでも高速な初期ロードを実現します。

#### 5. バグ修正と改善
- **`CACHE_TARGET_SHEETS`の構造変更**: オブジェクト形式`{[シート名]: startRow}`から配列形式`[シート名, ...]`に変更しました。
- **エラーハンドリング**: キャッシュ更新時のエラー処理を改善し、より詳細なログを出力します。
- **コメントの充実**: 各関数の目的とパラメータを明確化しました。

#### 6. パフォーマンス最適化
- **キャッシュヒット率の向上**: トリガーによる自動更新で、常に最新のキャッシュデータを利用できます。
- **API呼び出し削減**: `getBatchSheetDataWithCache()`で複数シートのデータ取得時にキャッシュを効率的に活用します。
- **メモリ効率**: 不要なパラメータを削除し、関数シグネチャを簡素化しました。

---

## Ver 2.2.0 (2025年12月)

### 主な変更点

#### 1. データ型と比較演算子の厳格化
- **型統一**: Sheets API の仕様（全て文字列で返却）に合わせ、アプリケーション内でのデータ型を統一しました。
    - **大学コード**: 常に `String` 型として扱います。
    - **フラグ系**: 削除フラグや進学フラグは、専用のヘルパー関数 `isTrue()` を通して `Boolean` 型として扱います。
- **厳密な比較**: 比較演算子を `==` から `===` に変更し、予期せぬ型変換によるバグを防止しました。

#### 2. バグ修正
- **DOM操作エラーの修正**: 教員モードでのデータ読み込み時に発生していた `setElementHidden` 関連のエラー（DOM要素の指定ミス）を修正しました。
- **データ不整合対策**: `createData` 関数等のロジックを見直し、変数のスコープ定義（`const`）やフィルタリング条件を修正しました。

#### 3. UX改善
- **デザイン微調整**: `.selected-student` の配色を調整し、視認性を改善しました。

---

## Ver 2.1.1 (2025年12月)

### 修正および改善

#### 重複レコード問題の修正
- **データ不整合への堅牢性向上**: ユーザー入力（ログイン情報）と保存済みデータの間で、メールアドレスの大文字小文字の違いや、大学コードに含まれる空白文字の不一致により、既存レコードが認識されず重複登録されてしまう問題を修正しました。
- **保存ロジックの改善 (`saveExamDataList`)**: 重複データの判定ロジックを強化し、万が一重複が存在した場合でも、優先レコードを更新し、残りを論理削除するように変更しました。

#### コード整理
- **未使用関数の削除**: `main.js` から、API対応により不要となった関数を削除しました。
- **可読性向上**: `main.js` のクライアント連携関数セクションに機能別のサブヘッダーを追加し、コードの構造を把握しやすくしました。

---

## Ver 2.1.0 (2025年12月)

### 主な変更点

#### 1. サーバーサイドキャッシュの導入
- **設定・選択肢データのキャッシュ**: `SETTINGS`, `SEL_KEITAI`, `SEL_GOUHI` などのマスタデータを `CacheService` を用いてサーバー側でキャッシュするように変更しました。これにより、初期データ取得時のスプレッドシートへのアクセス回数が減少し、レスポンスが高速化されました。

#### 2. 保存処理のパフォーマンス向上
- **ロック待機時間の最適化**: `saveExamDataList` における排他制御のロック待機時間を短縮し、ユーザーの待ち時間を削減しました。
- **処理効率化**: 保存プロセス全体を見直し、より効率的なデータ書き込み処理を実現しました。

---

## Ver 2.0.0 (2025年12月)

### 主な変更点

#### 1. パフォーマンス最適化 (Google Sheets API 対応)
- **初期データ取得 (`getInitialData`)**: 従来の `getValues()` から `Sheets.Spreadsheets.Values.batchGet()` に変更し、複数シートのデータを1回のAPI呼び出しで取得するように改善しました。
- **受験データ取得 (`getExamDataList`)**: Google Sheets API (`Sheets.Spreadsheets.Values.get()`) を使用するようになりました。
- **受験データ保存 (`saveExamDataList`)**: 大規模リファクタリングを実施。
    - **検索処理**: 従来の全件取得 (`getDataRange`) を廃止し、対象ユーザーのみをAPI経由で検索・取得する方式 (`batchGet`) に変更。
    - **書き込み処理**: 個別の `setValue/setValues` を廃止し、`batchUpdate` (更新/削除) と `append` (追加) に統合。これによりスケーラビリティが大幅に向上しました。
    - **戻り値追加**: 保存完了後に最新の受験データリストを直接返すようになり、クライアント側での再取得が不要になりました。

#### 2. iFrame対応
- `doGet` 関数内に `html.setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)` を追加し、iFrame 内での表示を可能にしました（※ v2.3.0でセキュリティ考慮により変更）。

#### 3. キャッシュ戦略の変更
- **サーバーサイドキャッシュ廃止**: v1.0.0 で実装されていた `CacheService` によるサーバーサイドキャッシュ関連コード (`putCache`, `getCache`, `clearCache`, `getSheetData` のキャッシュ処理) を一時廃止しました。キャッシュ管理の複雑さとAPIパフォーマンス向上のトレードオフとして決定されました（※ v2.1.0以降で再導入・改善）。
- **クライアントサイドキャッシュ追加**: `script.html` において、大学データを `localStorage` に24時間キャッシュする機能を追加しました (`getUniversityDataList` 関数内)。これにより、大学検索時のロード時間を短縮しています。

#### 4. 教員モード改善
- `getStudentsList` 関数を新規追加し、教員モード時に生徒一覧を非同期で取得するように変更しました。初期ページロードの高速化に貢献しています。

#### 5. クライアントサイド改善 (`script.html`)
- **DOMキャッシュ導入**: `dom` オブジェクトにDOM要素をキャッシュし、`document.getElementById()` の呼び出し回数を削減しました。
- **is-hiddenクラス**: 要素の表示/非表示制御を `style.display` から `.is-hidden` クラスのトグルに変更し、CSS との一貫性を向上させました。
- **プログレスダイアログ改善**: よりユーザーフレンドリーなスピナー表示に変更。
- **データ補正ヘルパー追加**: `padRowsWithHeader` 関数を追加し、Sheets API からのデータ（行末の空セルが欠損する可能性）を安全に扱うようになりました。
- **Null安全対策**: 各種データ処理において `|| []` や `|| {}` による初期値設定を徹底し、予期せぬ `undefined` エラーを防止しました。

#### 6. カスタムメニュー変更
- `onOpen` 関数内のカスタムメニュー項目を改訂しました。
    - 「削除レコード完全削除」の呼び出し関数名を `deleteMarkedRows` から `queryDeleteMarkedRows` に変更（ダイアログ確認を追加したため）。

---

## Ver 1.0.0 (初期リリース)

- 基本的な受験校調査機能を実装。
- サーバーサイドキャッシュ (`CacheService`) を採用。
- 従来のGAS組み込み関数 (`getValues`, `setValues`) を使用。
