# バージョン変更履歴 (VERSION_CHANGES.md)

## Ver 2.3.1 (2026年1月)

### 修正および改善

#### 1. Base64デコードエラーの修正
- **エラー修正**: `GET data:application/octet-stream;base64,... net::ERR_INVALID_URL` エラーを修正しました。
  - **原因**: `fetch()` APIを使用したData URIスキームでのBase64データ取得が、長い文字列の場合に不安定になる問題
  - **対策**: `base64ToUint8ArrayAsync` 関数を `atob()` と手動変換方式に変更し、安定性を向上
  - **効果**: 大学データのキャッシュ読み込み時のエラーが解消され、信頼性が向上

#### 2. コード品質の改善
- **グローバル変数の整理**: `dom` オブジェクトを `config` から独立させ、グローバル変数として再配置
- **関数のモジュール化**: 以下の関数を可読性向上のためリファクタリング
  - `sendExamDataWithRetry`: 確認、UI初期化、データ収集、エラー処理を分割
  - `getUniversityDataList`: キャッシュ処理、サーバー通信、エラー処理をモジュール化
- **不要なコードの削除**: コメントアウトされた未使用コードや余分な空行を整理

#### 3. ハードコード値の特定
- **キャッシュ期間**: 大学データキャッシュの有効期限 `24 * 60 * 60 * 1000` (24時間) を特定
- **設定値**: 将来的な設定外部化のため、ハードコードされている値をリストアップ

---

## Ver 2.3.0 (2025年12月)

### 主な変更点

#### 1. 通信信頼性向上
- **自動リトライ機能の導入**: `runGoogleScriptWithRetry` 関数を新規追加し、指数バックオフ (Exponential Backoff) アルゴリズムによる自動リトライ機能を実装しました。
  - 最大リトライ回数: 3回
  - 初回待機時間: 2秒、待機時間は2倍ずつ増加 (2秒→4秒→8秒)
  - ジッター (Jitter) 機能: ±20% のランダムな待機時間変動により、複数ユーザーが同時にリトライする際の衝突を防止
  - ユーザー通知: リトライ中は画面に進捗状況を表示
- **データ送信処理の強化**: `sendExamDataWithRetry` 関数を更新し、自動リトライ機能を統合しました。これにより、一時的なネットワーク混雑時のデータ保存成功率が大幅に向上しました。

#### 2. キャッシュ戦略の再導入と最適化
- **サーバーサイドキャッシュ復活**: パフォーマンス向上のため、`getBatchSheetDataWithCache` 関数によりマスタデータ（設定、選択肢、生徒・教員データ）のキャッシュ機能を再導入しました。
  - キャッシュ期間: 6時間
  - 対象シート: SETTINGS, TEACHERS, STUDENTS, SEL_GOUHI, SEL_KEITAI
- **自動キャッシュ更新**: シート編集時 (`onEdit`) および変更時 (`onChange`) にキャッシュを自動更新するトリガー機能を強化しました。
- **定期的キャッシュ更新**: 3時間ごとに全キャッシュを更新する自動トリガーを設定する `setupTriggers` 関数を追加しました。

#### 3. 大学データ管理機能の強化
- **シリアル番号管理**: 大学データ更新時に自動でシリアル番号をインクリメントする `incrementUniversitySerial` 関数を追加。設定シートのB5セルを自動更新し、クライアントサイドキャッシュの無効化判定に使用します。
- **Benesseデータインポート機能改善**: `importUniversityData` 関数を更新し、大学コードの重複チェックと既存データの上書き処理を最適化しました。

#### 4. UI/UX改善
- **ダークモード対応**: `css.html` に `@media (prefers-color-scheme: dark)` を追加し、システムのダークモード設定に自動で対応するようにしました。
- **レスポンシブデザイン強化**: タブレット端末 (701px-900px) におけるテーブル表示をグリッドレイアウトに変更し、より見やすい配置に改善しました。
- **カラーテーマの統一**: CSS変数 (`--color-*`) を使用し、一貫性のあるデザインシステムを導入しました。

#### 5. コード品質向上
- **関数名の統一**: `saveExamDataList` から `sendExamData` に関数名を変更し、命名規則を統一しました。
- **エラーハンドリング強化**: 各関数のエラーメッセージを具体化し、デバッグ効率を向上させました。
- **型安全性の向上**: Boolean値の判定には `isTrue()` ヘルパー関数を統一して使用し、Sheets API の文字列返却仕様に完全対応しました。

---

## Ver 2.2.0 (2025年12月)

### 主な変更点

#### 1. データ型と比較演算子の厳格化
- **型統一**: Sheets API の仕様（全て文字列で返却）に合わせ、アプリケーション内でのデータ型を統一しました。
    - **大学コード**: 常に `String` 型として扱います。
    - **フラグ系**: 削除フラグや進学フラグは、専用のヘルパー関数 `isTrue()` を通して `Boolean` 型として扱います。
- **厳密な比較**: 比較演算子を `==` から `===` に変更し、予期せぬ型変換によるバグを防止しました。

#### 2. バグ修正
- **DOM操作エラーの修正**: 教員モードでのデータ読み込み時に発生していた `setElementHidden` 関連のエラー（DOM要素の指定ミス）を修正しました。
- **データ不整合対策**: `createData` 関数等のロジックを見直し、変数のスコープ定義（`const`）やフィルタリング条件を修正しました。

#### 3. UX改善
- **デザイン微調整**: `.selected-student` の配色を調整し、視認性を改善しました。

---

## Ver 2.0.0 (2025年12月)

### 主な変更点

#### 1. パフォーマンス最適化 (Google Sheets API 対応)
- **初期データ取得 (`getInitialData`)**: 従来の `getValues()` から `Sheets.Spreadsheets.Values.batchGet()` に変更し、複数シートのデータを1回のAPI呼び出しで取得するように改善しました。
- **受験データ取得 (`getExamDataList`)**: Google Sheets API (`Sheets.Spreadsheets.Values.get()`) を使用するようになりました。
- **受験データ保存 (`saveExamDataList`)**: 大規模リファクタリングを実施。
    - **検索処理**: 従来の全件取得 (`getDataRange`) を廃止し、対象ユーザーのみをAPI経由で検索・取得する方式 (`batchGet`) に変更。
    - **書き込み処理**: 個別の `setValue/setValues` を廃止し、`batchUpdate` (更新/削除) と `append` (追加) に統合。これによりスケーラビリティが大幅に向上しました。
    - **戻り値追加**: 保存完了後に最新の受験データリストを直接返すようになり、クライアント側での再取得が不要になりました。

#### 2. iFrame対応
- `doGet` 関数内に `html.setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)` を追加し、iFrame 内での表示を可能にしました。

#### 3. キャッシュ戦略の変更
- **サーバーサイドキャッシュ廃止**: v1.0.0 で実装されていた `CacheService` によるサーバーサイドキャッシュ関連コード (`putCache`, `getCache`, `clearCache`, `getSheetData` のキャッシュ処理) を廃止しました。キャッシュ管理の複雑さとAPIパフォーマンス向上のトレードオフとして決定されました。
- **クライアントサイドキャッシュ追加**: `script.html` において、大学データを `localStorage` に24時間キャッシュする機能を追加しました (`getUniversityDataList` 関数内)。これにより、大学検索時のロード時間を短縮しています。

#### 4. 教員モード改善
- `getStudentsList` 関数を新規追加し、教員モード時に生徒一覧を非同期で取得するように変更しました。初期ページロードの高速化に貢献しています。
- `getFilteredUniversityDataList` 関数を追加し、大学データのサーバーサイド検索・ページネーションをサポートしました（将来拡張用、現時点ではクライアント検索がデフォルト）。

#### 5. クライアントサイド改善 (`script.html`)
- **DOMキャッシュ導入**: `dom` オブジェクトにDOM要素をキャッシュし、`document.getElementById()` の呼び出し回数を削減しました。
- **is-hiddenクラス**: 要素の表示/非表示制御を `style.display` から `.is-hidden` クラスのトグルに変更し、CSS との一貫性を向上させました。
- **プログレスダイアログ改善**: よりユーザーフレンドリーなスピナー表示に変更（ようこそメッセージの表示など）。
- **データ補正ヘルパー追加**: `padRowsWithHeader` 関数を追加し、Sheets API からのデータ（行末の空セルが欠損する可能性）を安全に扱うようになりました。
- **Null安全対策**: 各種データ処理において `|| []` や `|| {}` による初期値設定を徹底し、予期せぬ `undefined` エラーを防止しました。

#### 6. カスタムメニュー変更
- `onOpen` 関数内のカスタムメニュー項目を改訂しました。
    - 「キャッシュクリア」メニューは廃止。
    - 「削除レコード完全削除」の呼び出し関数名を `deleteMarkedRows` から `queryDeleteMarkedRows` に変更（ダイアログ確認を追加したため）。

---

## Ver 2.1.1 (2025年12月)

### 修正および改善

#### 重複レコード問題の修正
- **データ不整合への堅牢性向上**: ユーザー入力（ログイン情報）と保存済みデータの間で、メールアドレスの大文字小文字の違いや、大学コードに含まれる空白文字の不一致により、既存レコードが認識されず重複登録されてしまう問題を修正しました。
- **保存ロジックの改善 (`saveExamDataList`)**: 重複データの判定ロジックを強化し、万が一重複が存在した場合でも、優先レコードを更新し、残りを論理削除するように変更しました。

#### コード整理
- **未使用関数の削除**: `main.js` から、API対応により不要となった `getSheetData` 関数を削除しました。
- **可読性向上**: `main.js` のクライアント連携関数セクションに機能別のサブヘッダーを追加し、コードの構造を把握しやすくしました。

---

## Ver 2.1.0 (2025年12月)

### 主な変更点

#### 1. サーバーサイドキャッシュの導入
- **設定・選択肢データのキャッシュ**: `SETTINGS`, `SEL_KEITAI`, `SEL_GOUHI` などのマスタデータを `CacheService` を用いてサーバー側でキャッシュするように変更しました。これにより、初期データ取得時のスプレッドシートへのアクセス回数が減少し、レスポンスが高速化されました。

#### 2. 保存処理のパフォーマンス向上
- **ロック待機時間の最適化**: `saveExamDataList` における排他制御のロック待機時間を短縮し、ユーザーの待ち時間を削減しました。
- **処理効率化**: 保存プロセス全体を見直し、より効率的なデータ書き込み処理を実現しました。

---

## Ver 1.0.0 (初期リリース)

- 基本的な受験校調査機能を実装。
- サーバーサイドキャッシュ (`CacheService`) を採用。
- 従来のGAS組み込み関数 (`getValues`, `setValues`) を使用。
