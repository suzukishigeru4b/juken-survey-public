# バージョン変更履歴 (VERSION_CHANGES.md)

## Ver 2.4.0 (2025年12月)

### 主な変更点

#### 1. 大学データの圧縮転送
- **gzip圧縮対応**: サーバーからクライアントへの大学データ転送時に、gzip圧縮とBase64エンコーディングを適用しました。約600KBの大学データを効率的に転送できます。
- **ブラウザ標準API活用**: クライアント側では `DecompressionStream` を使用して解凍を行い、追加のライブラリなしで高速な解凍を実現しています（Chrome 80+対応）。

#### 2. 大学データキャッシュの自動更新（シリアル番号による）
- **シリアル番号管理**: 設定シートに `daigakuSerial`（大学データシリアル番号）を追加しました。Benesseデータインポート時に自動インクリメントされます。
- **キャッシュ有効性チェック**: クライアント側のlocalStorageキャッシュは、このシリアル番号と照合して有効性を判定します。シリアル番号が異なる場合、自動的に再取得が行われます。

#### 3. 受験校データのリトライ処理
- **Exponential Backoff実装**: サーバーへのデータ送信失敗時に、自動リトライ機能を追加しました。
    - 最大3回リトライ（設定変更可能）
    - 初回待機時間: 2秒、以後指数的に増加（2秒 → 4秒 → 8秒）
    - ジッター（±20%のランダム遅延）により、複数ユーザーの同時リトライ衝突を回避
- **ユーザー通知**: リトライ中はスピナーと共に「混雑中...再接続」メッセージを表示

#### 4. シートのデータ変更後、サーバキャッシュの自動更新
- **インストーラブルトリガー対応**: `onEdit` および `onChange` トリガーを追加し、対象シートの変更を監視します。
- **対象シート**: 設定、合否選択肢、受験形態選択肢、職員データ、学籍データ
- **即座反映**: 対象シートの編集・変更時に、該当シートのサーバーキャッシュ（`CacheService`）が即座に更新されます。

#### 5. 定期的な論理削除ファイルの完全削除
- **自動クリーンアップ**: `deleteMarkedRows` 関数を3時間ごとに自動実行し、削除フラグが付いたレコードを完全削除します。
- **排他制御**: `LockService` による排他制御を実装し、同時実行によるデータ不整合を防止（120秒タイムアウト）。

#### 6. サーバーキャッシュの定期的ウォームアップ
- **定期実行トリガー**: `warmUpAllCache` 関数を3時間ごとに自動実行し、主要なマスタデータのキャッシュを事前に更新します。
- **対象シート**: 設定、職員データ、学籍データ、合否選択肢、受験形態選択肢
- **キャッシュ有効期限**: 6時間（21600秒）

#### 7. トリガー管理機能
- **一括設定メニュー**: 管理者メニューに「キャッシュ更新トリガー設定」を追加。以下のトリガーを一括で設定・再設定できます：
    - `onEdit` (編集時キャッシュ更新)
    - `onChange` (変更時キャッシュ更新)
    - `warmUpAllCache` (3時間ごとのキャッシュウォームアップ)
    - `deleteMarkedRows` (3時間ごとの削除レコードクリーンアップ)
- **重複防止**: 既存の同名トリガーは自動的に削除してから新規作成します。

---

## Ver 2.2.0 (2025年12月)

### 主な変更点

#### 1. データ型と比較演算子の厳格化
- **型統一**: Sheets API の仕様（全て文字列で返却）に合わせ、アプリケーション内でのデータ型を統一しました。
    - **大学コード**: 常に `String` 型として扱います。
    - **フラグ系**: 削除フラグや進学フラグは、専用のヘルパー関数 `isTrue()` を通して `Boolean` 型として扱います。
- **厳密な比較**: 比較演算子を `==` から `===` に変更し、予期せぬ型変換によるバグを防止しました。

#### 2. バグ修正
- **DOM操作エラーの修正**: 教員モードでのデータ読み込み時に発生していた `setElementHidden` 関連のエラー（DOM要素の指定ミス）を修正しました。
- **データ不整合対策**: `createData` 関数等のロジックを見直し、変数のスコープ定義（`const`）やフィルタリング条件を修正しました。

#### 3. UX改善
- **デザイン微調整**: `.selected-student` の配色を調整し、視認性を改善しました。

---

## Ver 2.0.0 (2025年12月)

### 主な変更点

#### 1. パフォーマンス最適化 (Google Sheets API 対応)
- **初期データ取得 (`getInitialData`)**: 従来の `getValues()` から `Sheets.Spreadsheets.Values.batchGet()` に変更し、複数シートのデータを1回のAPI呼び出しで取得するように改善しました。
- **受験データ取得 (`getExamDataList`)**: Google Sheets API (`Sheets.Spreadsheets.Values.get()`) を使用するようになりました。
- **受験データ保存 (`saveExamDataList`)**: 大規模リファクタリングを実施。
    - **検索処理**: 従来の全件取得 (`getDataRange`) を廃止し、対象ユーザーのみをAPI経由で検索・取得する方式 (`batchGet`) に変更。
    - **書き込み処理**: 個別の `setValue/setValues` を廃止し、`batchUpdate` (更新/削除) と `append` (追加) に統合。これによりスケーラビリティが大幅に向上しました。
    - **戻り値追加**: 保存完了後に最新の受験データリストを直接返すようになり、クライアント側での再取得が不要になりました。

#### 2. iFrame対応
- `doGet` 関数内に `html.setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)` を追加し、iFrame 内での表示を可能にしました。

#### 3. キャッシュ戦略の変更
- **サーバーサイドキャッシュ廃止**: v1.0.0 で実装されていた `CacheService` によるサーバーサイドキャッシュ関連コード (`putCache`, `getCache`, `clearCache`, `getSheetData` のキャッシュ処理) を廃止しました。キャッシュ管理の複雑さとAPIパフォーマンス向上のトレードオフとして決定されました。
- **クライアントサイドキャッシュ追加**: `script.html` において、大学データを `localStorage` に24時間キャッシュする機能を追加しました (`getUniversityDataList` 関数内)。これにより、大学検索時のロード時間を短縮しています。

#### 4. 教員モード改善
- `getStudentsList` 関数を新規追加し、教員モード時に生徒一覧を非同期で取得するように変更しました。初期ページロードの高速化に貢献しています。
- `getFilteredUniversityDataList` 関数を追加し、大学データのサーバーサイド検索・ページネーションをサポートしました（将来拡張用、現時点ではクライアント検索がデフォルト）。

#### 5. クライアントサイド改善 (`script.html`)
- **DOMキャッシュ導入**: `dom` オブジェクトにDOM要素をキャッシュし、`document.getElementById()` の呼び出し回数を削減しました。
- **is-hiddenクラス**: 要素の表示/非表示制御を `style.display` から `.is-hidden` クラスのトグルに変更し、CSS との一貫性を向上させました。
- **プログレスダイアログ改善**: よりユーザーフレンドリーなスピナー表示に変更（ようこそメッセージの表示など）。
- **データ補正ヘルパー追加**: `padRowsWithHeader` 関数を追加し、Sheets API からのデータ（行末の空セルが欠損する可能性）を安全に扱うようになりました。
- **Null安全対策**: 各種データ処理において `|| []` や `|| {}` による初期値設定を徹底し、予期せぬ `undefined` エラーを防止しました。

#### 6. カスタムメニュー変更
- `onOpen` 関数内のカスタムメニュー項目を改訂しました。
    - 「キャッシュクリア」メニューは廃止。
    - 「削除レコード完全削除」の呼び出し関数名を `deleteMarkedRows` から `queryDeleteMarkedRows` に変更（ダイアログ確認を追加したため）。

---

## Ver 2.1.1 (2025年12月)

### 修正および改善

#### 重複レコード問題の修正
- **データ不整合への堅牢性向上**: ユーザー入力（ログイン情報）と保存済みデータの間で、メールアドレスの大文字小文字の違いや、大学コードに含まれる空白文字の不一致により、既存レコードが認識されず重複登録されてしまう問題を修正しました。
- **保存ロジックの改善 (`saveExamDataList`)**: 重複データの判定ロジックを強化し、万が一重複が存在した場合でも、優先レコードを更新し、残りを論理削除するように変更しました。

#### コード整理
- **未使用関数の削除**: `main.js` から、API対応により不要となった `getSheetData` 関数を削除しました。
- **可読性向上**: `main.js` のクライアント連携関数セクションに機能別のサブヘッダーを追加し、コードの構造を把握しやすくしました。

---

## Ver 2.1.0 (2025年12月)

### 主な変更点

#### 1. サーバーサイドキャッシュの導入
- **設定・選択肢データのキャッシュ**: `SETTINGS`, `SEL_KEITAI`, `SEL_GOUHI` などのマスタデータを `CacheService` を用いてサーバー側でキャッシュするように変更しました。これにより、初期データ取得時のスプレッドシートへのアクセス回数が減少し、レスポンスが高速化されました。

#### 2. 保存処理のパフォーマンス向上
- **ロック待機時間の最適化**: `saveExamDataList` における排他制御のロック待機時間を短縮し、ユーザーの待ち時間を削減しました。
- **処理効率化**: 保存プロセス全体を見直し、より効率的なデータ書き込み処理を実現しました。

---

## Ver 1.0.0 (初期リリース)

- 基本的な受験校調査機能を実装。
- サーバーサイドキャッシュ (`CacheService`) を採用。
- 従来のGAS組み込み関数 (`getValues`, `setValues`) を使用。
